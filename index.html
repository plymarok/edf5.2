<!DOCTYPE html>
<html lang="fr" data-theme="light">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Calcul norm√© ‚Äî AP P√®re & Fils / P√®re, Fils & Petit-fils</title>
<meta name="color-scheme" content="light dark" />
<style>
  :root{
    --bg:#f7f7fb; --panel:#fff; --text:#16161b; --muted:#6b7280;
    --accent:#4f46e5; --accent-weak:#eef2ff;
    --border:#e7e7ef; --shadow:0 10px 26px rgba(16,24,40,.06);
    --col-pere:#4f46e5; --col-fils:#10b981; --col-petit:#a855f7;
  }
  html[data-theme="dark"]{
    --bg:#0f1115; --panel:#161a22; --text:#e9e9f2; --muted:#9aa0aa;
    --accent:#8b93ff; --accent-weak:#1e2330; --border:#262b36; --shadow:0 12px 28px rgba(0,0,0,.45);
    --col-pere:#8b93ff; --col-fils:#34d399; --col-petit:#c084fc;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  .topbar{position:sticky;top:0;z-index:10;display:flex;align-items:center;justify-content:space-between;gap:12px;
    padding:14px 18px;background:var(--panel);border-bottom:1px solid var(--border);box-shadow:var(--shadow)}
  .topbar h1{font-size:18px;margin:0}
  .btn{border-radius:10px;border:1px solid var(--border);background:var(--panel);color:var(--text);padding:10px 14px;cursor:pointer}
  .btn.primary{background:var(--accent);color:#fff;border-color:transparent}
  .btn.ghost{background:transparent}

  .tabs{display:flex;gap:8px;margin:16px auto;max-width:1100px;padding:0 18px}
  .tab{padding:10px 14px;border:1px solid var(--border);border-radius:10px;background:var(--panel);cursor:pointer}
  .tab.active{background:var(--accent);color:#fff;border-color:transparent}

  .container{max-width:1100px;margin:0 auto 24px;padding:0 18px;display:grid;gap:18px}
  .panel{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:16px 16px 20px;box-shadow:var(--shadow)}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:14px}
  .row{display:grid;grid-template-columns:260px 1fr;gap:10px;align-items:center;margin:8px 0}
  .help{grid-column:1/-1;margin:-4px 0 6px 260px;font-size:12px;color:var(--muted)}
  .section{margin-top:14px}
  .control{background:transparent;border:1px solid var(--border);border-radius:10px;padding:10px 12px;color:var(--text);width:100%}
  .control:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px var(--accent-weak)}
  .muted{color:var(--muted)} .mono{font-variant-numeric:tabular-nums}
  textarea{width:100%;min-height:120px;resize:vertical;border-radius:10px;border:1px solid var(--border);padding:10px}
  .chroniqueLive{min-height:260px;border:1px solid var(--border);border-radius:12px;padding:14px;background:var(--panel)}
  .chroniqueLive h4{margin:6px 0 8px} .chroniqueLive p{margin:6px 0}
  .chip{display:inline-block;background:var(--accent-weak);padding:2px 8px;border-radius:999px}

  svg.timeline{width:100%;height:220px}
  .mini-tabs{display:flex;gap:8px;margin:10px 0}
  .mini-tab{padding:6px 10px;border:1px solid var(--border);border-radius:8px;background:var(--panel);cursor:pointer;font-size:14px}
  .mini-tab.active{background:var(--accent);color:#fff;border-color:transparent}
  .viz-pane{display:none}
  .viz-pane.active{display:block}
  .legend{display:flex;gap:14px;align-items:center;font-size:13px;color:var(--muted);margin-top:8px}
  .swatch{width:12px;height:12px;border-radius:3px;display:inline-block}
  .sw-pere{background:var(--col-pere)} .sw-fils{background:var(--col-fils)} .sw-petit{background:var(--col-petit)}

  .tab-panel{display:none}
  .tab-panel.active{display:grid}
</style>
</head>
<body>
<header class="topbar">
  <h1>Calcul norm√© ‚Äî Augmentations de puissance (p√®re, fils, petit-fils)</h1>
  <div class="actions">
    <button id="theme" class="btn ghost" type="button">üåô/‚òÄÔ∏è</button>
  </div>
</header>

<nav class="tabs">
  <button class="tab active" data-panel="pf1" type="button">P√®re & Fils ‚Äî 1 AP</button>
  <button class="tab" data-panel="pf2" type="button">P√®re, Fils & Petit-fils ‚Äî 2 AP</button>
</nav>

<!-- =================== ONGLET 1 : P√àRE & FILS (1 AP) =================== -->
<main id="pf1" class="container tab-panel active">
  <section class="panel">
    <h3>1) Renseigner le cas ‚Äî P√®re & Fils (1 seule augmentation)</h3>
    <div class="grid">
      <div>
        <h4>P√©riode de facturation</h4>
        <div class="row"><label>D√©but de p√©riode</label><input id="fStart1" type="date" class="control"></div>
        <div class="row"><label>Fin de p√©riode</label><input id="fEnd1" type="date" class="control"></div>
        <p class="help">C‚Äôest la p√©riode r√©elle de la facture que tu traites.</p>

        <h4 class="section">Rep√®res d‚Äôindex (p√®re)</h4>
        <div class="row"><label>Fin de facture pr√©c√©dente (N-1)</label><input id="dStart1" type="date" class="control"></div>
        <div class="row"><label>Index au N-1 (p√®re)</label><input id="iStart1" type="number" step="1" class="control" placeholder="ex. 12 000"></div>
        <div class="row"><label>Date d‚Äôaugmentation (AP)</label><input id="dAP1" type="date" class="control"></div>
        <div class="row"><label>Index le jour d‚ÄôAP</label><input id="iAP1" type="number" step="1" class="control" placeholder="ex. 18 450"></div>
        <div class="row"><label>Date anniversaire (1re facture apr√®s AP)</label><input id="dEnd1" type="date" class="control"></div>
        <div class="row"><label>Index √† l‚Äôanniversaire</label><input id="iEnd1" type="number" step="1" class="control" placeholder="ex. 25 380"></div>

        <h4 class="section">R√©partition apr√®s AP</h4>
        <div class="row"><label>Part du p√®re (apr√®s AP)</label><input id="coef1" type="number" step="0.01" min="0" max="1" class="control" placeholder="ex. 0.70 = 70 %"></div>
        <p class="help">Avant l‚ÄôAP, le p√®re prend 100 % de la production. Apr√®s l‚ÄôAP, on applique ce coefficient.</p>

        <div class="row"><label>Prix (‚Ç¨/kWh) <span class="muted">(facultatif)</span></label>
          <input id="price1" type="text" class="control" placeholder="ex. 0.10">
        </div>

        <div style="display:flex;gap:8px;margin-top:10px">
          <button id="exA1" class="btn" type="button">Exemple (70 %)</button>
          <button id="exB1" class="btn" type="button">Exemple (80 %)</button>
          <button id="clear1" class="btn" type="button">Vider</button>
        </div>
      </div>

      <div>
        <h4>Chronique ‚Äî explication en temps r√©el</h4>
        <div id="chroniqueLive1" class="chroniqueLive"></div>
      </div>
    </div>
    <div id="timeline1" style="margin-top:14px"></div>
  </section>

  <section class="panel">
    <h3>2) BAP ‚Äî Commentaire norm√© (pr√™t √† copier)</h3>
    <textarea id="bap1" class="mono" readonly></textarea>
    <div style="display:flex;gap:10px;margin-top:8px">
      <button id="copy1" class="btn primary" type="button">Copier le BAP</button>
      <span class="muted">Tol√©rance ¬± 1 kWh ‚Ä¢ Arrondi sur la part p√®re</span>
    </div>
  </section>
</main>

<!-- =================== ONGLET 2 : P√àRE, FILS & PETIT-FILS (2 AP) =================== -->
<main id="pf2" class="container tab-panel">
  <section class="panel">
    <h3>1) Renseigner le cas ‚Äî P√®re, Fils & Petit-fils (deux augmentations)</h3>
    <div class="grid">
      <div>
        <h4>P√©riode de facturation</h4>
        <div class="row"><label>D√©but de p√©riode</label><input id="fStart2" type="date" class="control"></div>
        <div class="row"><label>Fin de p√©riode</label><input id="fEnd2" type="date" class="control"></div>
        <p class="help">P√©riode r√©elle couverte par la facture.</p>

        <h4 class="section">Rep√®res d‚Äôindex (p√®re)</h4>
        <div class="row"><label>Fin de facture pr√©c√©dente (N-1)</label><input id="dStart2" type="date" class="control"></div>
        <div class="row"><label>Index au N-1 (p√®re)</label><input id="iStart2" type="number" step="1" class="control" placeholder="ex. 5 000"></div>

        <div class="row"><label>AP1 ‚Äî Date d‚Äôentr√©e du fils</label><input id="dAP21" type="date" class="control"></div>
        <div class="row"><label>Index le jour d‚ÄôAP1</label><input id="iAP21" type="number" step="1" class="control" placeholder="ex. 6 200"></div>

        <div class="row"><label>AP2 ‚Äî Date d‚Äôentr√©e du petit-fils</label><input id="dAP22" type="date" class="control"></div>
        <div class="row"><label>Index le jour d‚ÄôAP2</label><input id="iAP22" type="number" step="1" class="control" placeholder="ex. 9 100"></div>

        <div class="row"><label>Date anniversaire (1re facture apr√®s AP2)</label><input id="dEnd2" type="date" class="control"></div>
        <div class="row"><label>Index √† l‚Äôanniversaire</label><input id="iEnd2" type="number" step="1" class="control" placeholder="ex. 11 200"></div>

        <h4 class="section">R√©partition par sc√©nario</h4>
        <div class="row"><label>Entre AP1 et AP2 ‚Äî part du p√®re</label><input id="coef21_pere" type="number" step="0.01" min="0" max="1" class="control" placeholder="ex. 0.70 = 70 %"></div>
        <p class="help">Dans cette p√©riode, le couple <b>p√®re / fils</b> se partage la production (p√®re = x %, fils = 100 ‚àí x %).</p>

        <div class="row"><label>Apr√®s AP2 ‚Äî part du p√®re</label><input id="coef22_pere" type="number" step="0.01" min="0" max="1" class="control" placeholder="ex. 0.60 = 60 %"></div>
        <div class="row"><label>Apr√®s AP2 ‚Äî part du fils</label><input id="coef22_fils" type="number" step="0.01" min="0" max="1" class="control" placeholder="ex. 0.25 = 25 %"></div>
        <div class="row"><label>Apr√®s AP2 ‚Äî part du petit-fils</label><input id="coef22_petit" type="number" step="0.01" min="0" max="1" class="control" placeholder="ex. 0.15 = 15 %"></div>
        <p class="help">Apr√®s AP2, <b>les trois parts doivent totaliser 100 %</b> (p√®re + fils + petit-fils = 1.00).</p>

        <div class="row"><label>Prix (‚Ç¨/kWh) <span class="muted">(facultatif)</span></label><input id="price2" type="text" class="control" placeholder="ex. 0.10"></div>

        <div style="display:flex;gap:8px;margin-top:10px">
          <button id="ex2" class="btn" type="button">Charger un exemple</button>
          <button id="clear2" class="btn" type="button">Vider</button>
        </div>
      </div>

      <div>
        <h4>Chronique ‚Äî explication en temps r√©el</h4>
        <div id="chroniqueLive2" class="chroniqueLive"></div>
      </div>
    </div>

    <div class="mini-tabs">
      <button class="mini-tab active" data-viz="time2" type="button">Ligne de vie</button>
      <button class="mini-tab" data-viz="stack2" type="button">Histogramme par segment</button>
    </div>
    <div id="viz-time2" class="viz-pane active"><div id="timeline2"></div></div>
    <div id="viz-stack2" class="viz-pane"><div id="timeline2bars"></div>
      <div class="legend">
        <span class="swatch sw-pere"></span> p√®re
        <span class="swatch sw-fils"></span> fils
        <span class="swatch sw-petit"></span> petit-fils
      </div>
    </div>
  </section>

  <section class="panel">
    <h3>2) BAP ‚Äî Commentaire norm√© (pr√™t √† copier)</h3>
    <textarea id="bap2" class="mono" readonly></textarea>
    <div style="display:flex;gap:10px;margin-top:8px">
      <button id="copy2" class="btn primary" type="button">Copier le BAP</button>
      <span class="muted">Apr√®s AP2, les 3 parts doivent faire 100 %</span>
    </div>
  </section>
</main>

<script>
/* =================== Th√®me =================== */
(function(){
  const root=document.documentElement, key="ap-theme";
  const saved=localStorage.getItem(key); if(saved) root.setAttribute("data-theme", saved);
  document.getElementById("theme").onclick=()=>{
    const next=root.getAttribute("data-theme")==="dark"?"light":"dark";
    root.setAttribute("data-theme", next); localStorage.setItem(key,next);
  };
})();

/* =================== Onglets =================== */
document.querySelectorAll('.tabs .tab').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    document.querySelectorAll('.tabs .tab').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    document.querySelectorAll('.tab-panel').forEach(p=>p.classList.remove('active'));
    document.getElementById(btn.dataset.panel).classList.add('active');
  });
});

/* =================== Helpers =================== */
const raw = n => String(n);
const fmtDate = s => s ? new Date(s+"T00:00:00").toLocaleDateString("fr-FR") : "";
const asNum = v => (v===""||v==null)? NaN : Number(String(v).replace(",","."));
const pctText = x => (x*100).toLocaleString("fr-FR",{maximumFractionDigits:2}).replace(/\u00a0/g," ");
const diffDays=(a,b)=>Math.round((new Date(b)-new Date(a))/(1000*3600*24));
function guessPeriodLabel(a,b){
  if(!(a&&b)) return "";
  const d=diffDays(a,b);
  if(d>=330) return "p√©riode annuelle";
  if(d>=170 && d<=200) return "p√©riode semestrielle";
  return `p√©riode de ${d} jours`;
}

/* Timeline */
function drawTimeline(host, marks){
  host.innerHTML="";
  const svgNS="http://www.w3.org/2000/svg";
  const svg=document.createElementNS(svgNS,"svg");
  svg.setAttribute("class","timeline");
  svg.setAttribute("viewBox","0 0 1100 220");
  svg.setAttribute("preserveAspectRatio","xMidYMid meet");
  host.appendChild(svg);

  const valid=marks.filter(m=>m.d instanceof Date && !isNaN(m.d));
  if(valid.length<2){
    const p=document.createElement("div");
    p.className="muted"; p.textContent="Renseigne la p√©riode et les jalons : la ligne de vie se dessine.";
    host.appendChild(p); return;
  }
  valid.sort((a,b)=>a.d-b.d);
  const min=valid[0].d.getTime(), max=valid[valid.length-1].d.getTime();
  const span=Math.max(1,(max-min));
  const X=t=>40+((t-min)/span)*1020;

  function N(tag,attrs){const n=document.createElementNS(svgNS,tag);for(const k in attrs)n.setAttribute(k,attrs[k]);svg.appendChild(n);return n;}
  function vmark(x){N("line",{x1:x,y1:70,x2:x,y2:110,stroke:"currentColor","stroke-width":3});}
  function label(t,x,y,anchor="start",size=14){const n=N("text",{x,y,"text-anchor":anchor,"font-size":size}); n.textContent=t;}

  const fstart=marks.find(m=>m.tag==="fstart"), fend=marks.find(m=>m.tag==="fend");
  if(fstart?.d && fend?.d){
    const x1=X(fstart.d.getTime()), x2=X(fend.d.getTime());
    N("rect",{x:Math.min(x1,x2),y:78,width:Math.abs(x2-x1),height:24,fill:"var(--accent-weak)",opacity:"0.6"});
    label("P√©riode de facturation",(x1+x2)/2,66,"middle",12);
  }

  N("line",{x1:X(valid[0].d.getTime()),y1:90,x2:X(valid[valid.length-1].d.getTime()),y2:90,stroke:"#2a63e7","stroke-width":6,"stroke-linecap":"round"});

  valid.forEach(m=>{
    const x=X(m.d.getTime()); vmark(x);
    label(m.d.toLocaleDateString("fr-FR"),x,36,"middle");
    if(Number.isFinite(m.idx)) label(raw(m.idx),x,140,"middle");
    if(m.lbl) label(m.lbl,x,168,"middle",12);
  });
}

/* =================== ONGLET 1 (P√®re & Fils) =================== */
const fStart1=document.getElementById('fStart1'), fEnd1=document.getElementById('fEnd1');
const dStart1=document.getElementById('dStart1'), iStart1=document.getElementById('iStart1');
const dAP1=document.getElementById('dAP1'), iAP1=document.getElementById('iAP1');
const dEnd1=document.getElementById('dEnd1'), iEnd1=document.getElementById('iEnd1');
const coef1=document.getElementById('coef1'), price1=document.getElementById('price1');
const timeline1=document.getElementById('timeline1'), bap1=document.getElementById('bap1');
let chroniqueLive = document.getElementById('chroniqueLive1');

function renderChroniqueLive(values){
  const { FS, FE, ds, S, da, A, de, E, k, q1, q2, fatherAfter, childAfter, fatherTotal, validOrder, ok1, ok2, ready } = values;
  const L = [];
  if (FS && FE) {
    L.push(`<h4>Le cadre</h4>
       <p>Tu traites une <span class="chip">${guessPeriodLabel(FS,FE)}</span> :
       du <b>${fmtDate(FS)}</b> au <b>${fmtDate(FE)}</b>. La production est d‚Äôabord 100 % p√®re, puis ventil√©e apr√®s l‚ÄôAP.</p>`);
  } else {
    L.push(`<h4>Le cadre</h4><p class="muted">Indique le d√©but et la fin de la facture ; on posera ensuite les rep√®res.</p>`);
  }
  const jalons = [];
  if (ds) jalons.push(`√† la <b>cl√¥ture pr√©c√©dente (N-1)</b> (${fmtDate(ds)}) : <b>${Number.isFinite(S)?String(S):"?"}</b> kWh`);
  if (da) jalons.push(`le <b>jour de l‚ÄôAP</b> (${fmtDate(da)}) : <b>${Number.isFinite(A)?String(A):"?"}</b> kWh`);
  if (de) jalons.push(`√† la <b>date anniversaire</b> (${fmtDate(de)}) : <b>${Number.isFinite(E)?String(E):"?"}</b> kWh`);
  L.push(jalons.length ? `<p>Rep√®res : ${jalons.join(" ‚Ä¢ ")}.</p>` : `<p class="muted">Rep√®res attendus : N-1 ‚Üí AP ‚Üí Anniversaire.</p>`);
  if (da && de) {
    if (k >= 0 && k <= 1) {
      L.push(`<p>Apr√®s l‚ÄôAP, la ventilation est de <b>${pctText(k)} %</b> au p√®re et <b>${pctText(1-k)} %</b> au fils.</p>`);
    } else {
      L.push(`<p class="muted">Saisis la part du p√®re apr√®s AP (entre 0 et 1). Avant AP : 100 % p√®re.</p>`);
    }
  }
  if (ready) {
    L.push(`<h4>Calcul clair</h4>
       <p>Avant AP : <b>${A} ‚àí ${S} = ${q1} kWh</b> (100 % p√®re).</p>
       <p>Apr√®s AP : <b>${E} ‚àí ${A} = ${q2} kWh</b> ‚Üí p√®re <b>${fatherAfter}</b> ‚Ä¢ fils <b>${childAfter}</b>.</p>
       <p><b>Part p√®re attendue :</b> <b>${fatherTotal} kWh</b>.</p>
       <p>${ok1 ? "‚úÖ" : "‚ùå"} Les parts recomposent bien Q_apr√®s ‚Ä¢ ${ok2 ? "‚úÖ" : "‚ùå"} Q_avant + Q_apr√®s = Œîindex.</p>`);
  } else if (ds && da && de && !validOrder) {
    L.push(`<p class="muted">‚ö† Ordre requis : <b>N-1 ‚â§ AP ‚â§ Anniversaire</b> et index croissants.</p>`);
  }
  chroniqueLive.innerHTML = L.join("");
}

function compute1(){
  chroniqueLive = document.getElementById('chroniqueLive1');
  const FS=fStart1.value, FE=fEnd1.value;
  const ds=dStart1.value, da=dAP1.value, de=dEnd1.value;
  const S=asNum(iStart1.value), A=asNum(iAP1.value), E=asNum(iEnd1.value);
  const k=asNum(coef1.value);
  const validOrder = (ds && da && de) ? (new Date(ds)<=new Date(da) && new Date(da)<=new Date(de) && S<=A && A<=E) : false;

  let q1=NaN,q2=NaN,fatherAfter=NaN,childAfter=NaN,fatherTotal=NaN, ok1=false, ok2=false;
  const ready = ds && da && de && [S,A,E].every(Number.isFinite) && (k>=0 && k<=1) && validOrder;

  if(ready){
    q1=A-S; q2=E-A;
    fatherAfter=Math.round(q2*k); childAfter=q2-fatherAfter; fatherTotal=q1+fatherAfter;
    ok1=(fatherAfter+childAfter===q2); ok2=((E-S)===(q1+q2));
  }

  drawTimeline(timeline1,[
    {tag:"fstart",d:FS?new Date(FS):null},
    {tag:"fend",d:FE?new Date(FE):null},
    {d:ds?new Date(ds):null,idx:S},
    {d:da?new Date(da):null,idx:A},
    {d:de?new Date(de):null,idx:E},
    {d:(ds&&da)?new Date((+new Date(ds)+(+new Date(da)))/2):null,lbl:"100 % p√®re"},
    {d:(da&&de)?new Date((+new Date(da)+(+new Date(de)))/2):null,lbl:(k>=0&&k<=1?`${pctText(k)} % p√®re`:"")}
  ]);

  const coefPct=pctText(k);
  if(ready){
    let line = `BAP : augmentation de puissance au ${fmtDate(da)} (index ${raw(A)}) ; ` +
               `avant AP : ${raw(A)} - ${raw(S)} = ${raw(q1)} ; ` +
               `apr√®s AP : ${raw(E)} - ${raw(A)} = ${raw(q2)} √ó ${coefPct} % = ${raw(fatherAfter)} ` +
               `‚áí quantit√© attendue (p√®re) = ${raw(q1)} + ${raw(fatherAfter)}`;
    const pStr=(price1.value||"").trim(), pNum=asNum(pStr);
    if(pStr && Number.isFinite(pNum)){
      const amount=(fatherTotal*pNum).toLocaleString("fr-FR",{minimumFractionDigits:2,maximumFractionDigits:2});
      line += ` soit ${raw(fatherTotal)} √ó ${pStr} = ${amount}‚Ç¨`;
    }
    bap1.value=line;
  } else { bap1.value=""; }

  renderChroniqueLive({FS,FE,ds,S,da,A,de,E,k,q1,q2,fatherAfter,childAfter,fatherTotal,validOrder,ok1,ok2,ready});
}

/* =================== ONGLET 2 (P√®re, Fils & Petit-fils) =================== */
const fStart2=document.getElementById('fStart2'), fEnd2=document.getElementById('fEnd2');
const dStart2=document.getElementById('dStart2'), iStart2=document.getElementById('iStart2');
const dAP21=document.getElementById('dAP21'), iAP21=document.getElementById('iAP21');
const dAP22=document.getElementById('dAP22'), iAP22=document.getElementById('iAP22');
const dEnd2=document.getElementById('dEnd2'), iEnd2=document.getElementById('iEnd2');
const coef21_pere=document.getElementById('coef21_pere');
const coef22_pere=document.getElementById('coef22_pere');
const coef22_fils=document.getElementById('coef22_fils');
const coef22_petit=document.getElementById('coef22_petit');
const price2=document.getElementById('price2');
const timeline2=document.getElementById('timeline2'), bap2=document.getElementById('bap2');
const chrono2=document.getElementById('chroniqueLive2');
const bars2=document.getElementById('timeline2bars');

document.querySelectorAll('.mini-tab').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    document.querySelectorAll('.mini-tab').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    document.querySelectorAll('.viz-pane').forEach(p=>p.classList.remove('active'));
    document.getElementById('viz-'+btn.dataset.viz).classList.add('active');
  });
});

function renderChroniqueLive2(v){
  const {FS,FE,ds,S,da1,A1,da2,A2,de,E,k1,k2p,k2f,k2c,
         q1,q2,q3,p1,c1,p2,c2,g2,totP,
         validOrder, coefsOK2, okSeg2, okSeg3, okDelta, ready} = v;

  const L=[];
  if (FS && FE){
    L.push(`<h4>Le cadre</h4>
      <p>P√©riode trait√©e : <b>${fmtDate(FS)}</b> ‚Üí <b>${fmtDate(FE)}</b> (<span class="chip">${guessPeriodLabel(FS,FE)}</span>), avec deux augmentations : AP1 (entr√©e du fils) puis AP2 (entr√©e du petit-fils).</p>`);
  } else {
    L.push(`<h4>Le cadre</h4><p class="muted">Renseigne la p√©riode de la facture.</p>`);
  }

  const R=[];
  if (ds)  R.push(`N-1 ${fmtDate(ds)} : <b>${Number.isFinite(S)?S:"?"}</b>`);
  if (da1) R.push(`AP1 ${fmtDate(da1)} : <b>${Number.isFinite(A1)?A1:"?"}</b>`);
  if (da2) R.push(`AP2 ${fmtDate(da2)} : <b>${Number.isFinite(A2)?A2:"?"}</b>`);
  if (de)  R.push(`Anniv. ${fmtDate(de)} : <b>${Number.isFinite(E)?E:"?"}</b>`);
  L.push(R.length?`<p>Rep√®res index : ${R.join(" ‚Ä¢ ")}.</p>`:`<p class="muted">Rep√®res attendus : N-1 ‚Üí AP1 ‚Üí AP2 ‚Üí Anniversaire.</p>`);

  if (da1 && da2) L.push(`<p><b>Entre AP1 et AP2</b> : p√®re <b>${pctText(k1)} %</b> ‚Ä¢ fils <b>${pctText(1-k1)} %</b>.</p>`);
  if (de){
    if (coefsOK2){
      L.push(`<p><b>Apr√®s AP2</b> : p√®re <b>${pctText(k2p)} %</b> ‚Ä¢ fils <b>${pctText(k2f)} %</b> ‚Ä¢ petit-fils <b>${pctText(k2c)} %</b> (100 % au total).</p>`);
    } else {
      L.push(`<p class="muted">Apr√®s AP2, renseigne 3 parts (p√®re/fils/petit-fils) qui totalisent 100 %.</p>`);
    }
  }

  if (ready){
    L.push(`<h4>Calcul clair</h4>
      <p>Avant AP1 : <b>${A1} ‚àí ${S} = ${q1} kWh</b> (100 % p√®re).</p>
      <p>AP1 ‚Üí AP2 : <b>${A2} ‚àí ${A1} = ${q2} kWh</b> ‚Üí p√®re <b>${p1}</b> ‚Ä¢ fils <b>${c1}</b>.</p>
      <p>Apr√®s AP2 : <b>${E} ‚àí ${A2} = ${q3} kWh</b> ‚Üí p√®re <b>${p2}</b> ‚Ä¢ fils <b>${c2}</b> ‚Ä¢ petit-fils <b>${g2}</b>.</p>
      <p><b>Part p√®re attendue :</b> <b>${totP} kWh</b>.</p>
      <p>${okSeg2?"‚úÖ":"‚ùå"} S2 : parts = Q‚ÇÇ ‚Ä¢ ${okSeg3?"‚úÖ":"‚ùå"} S3 : parts = Q‚ÇÉ ‚Ä¢ ${okDelta?"‚úÖ":"‚ùå"} S1+S2+S3 = Œîindex.</p>`);

    const repS2 = `${pctText(k1)} % au p√®re et ${pctText(1 - k1)} % au fils`;
    const repS3 = `${pctText(k2p)} % au p√®re, ${pctText(k2f)} % au fils, ${pctText(k2c)} % au petit-fils`;

    L.push(
      `<h4>R√©sum√©</h4>
       <p>Sur cette p√©riode, <b>AP1 le ${fmtDate(da1)}</b> (index ${A1}) fait entrer le fils : la production est ventil√©e ${repS2} jusqu‚Äô√† <b>AP2 le ${fmtDate(da2)}</b> (index ${A2}). Puis, d‚ÄôAP2 √† l‚Äôanniversaire (${fmtDate(de)}), la r√©partition devient ${repS3}.</p>
       <p>La part facturable au <b>p√®re</b> s‚Äô√©tablit √† <b>${totP} kWh</b> (= ${q1} + ${p1} + ${p2}).</p>`
    );
  } else if (ds && da1 && da2 && de && !validOrder){
    L.push(`<p class="muted">‚ö† Ordre chronologique : <b>N-1 ‚â§ AP1 ‚â§ AP2 ‚â§ Anniversaire</b> et index croissants.</p>`);
  }

  if (!ready){
    const miss=[];
    if(!FS||!FE) miss.push("p√©riode");
    if(!ds||!Number.isFinite(S)) miss.push("index N-1");
    if(!da1||!Number.isFinite(A1)) miss.push("index AP1");
    if(!da2||!Number.isFinite(A2)) miss.push("index AP2");
    if(!de||!Number.isFinite(E)) miss.push("index anniversaire");
    if(!(k1>=0&&k1<=1)) miss.push("part du p√®re entre AP1 et AP2");
    if(!coefsOK2) miss.push("parts p√®re/fils/petit-fils apr√®s AP2 (somme 1)");
    if(miss.length) L.push(`<p class="muted">√Ä compl√©ter : ${miss.join(" ‚Ä¢ ")}.</p>`);
  }

  chrono2.innerHTML=L.join("");
}

/* === Histogramme avec l√©gendes sous chaque segment ‚Äî marge gauche √©largie === */
function drawStackedPF2(host, data){
  const {q1,q2,q3,p1,c1,p2,c2,g2, ds, da1, da2, de} = data;

  host.innerHTML="";
  const svgNS="http://www.w3.org/2000/svg";
  const svg=document.createElementNS(svgNS,"svg");
  svg.setAttribute("viewBox","0 0 1100 300");
  svg.setAttribute("preserveAspectRatio","xMidYMid meet");
  host.appendChild(svg);

  function N(tag,attrs){const n=document.createElementNS(svgNS,tag);for(const k in attrs)n.setAttribute(k,attrs[k]);svg.appendChild(n);return n;}
  function label(t,x,y,anchor="start",size=13){const n=N("text",{x,y,"text-anchor":anchor,"font-size":size,fill:"currentColor"}); n.textContent=t;}
  function safe(n){return Number.isFinite(n)?n:0}

  function barRow(y, segments, title, qty, caption){
    // ‚¨á‚¨á marge gauche port√©e √† 160px pour √©viter la coupe des titres
    const left=160, right=1060, width=right-left, height=28, radius=6;
    const sumW=segments.reduce((s,s1)=>s+safe(s1.w),0)||1;
    let x=left;

    label(`${title}`, left-12, y+20, "end", 13);
    label(`${safe(qty)} kWh`, right+10, y+20, "start", 13);

    segments.forEach(s=>{
      const w = width*(safe(s.w)/sumW);
      if(w<=0) return;
      N("rect",{x, y, width:w, height, rx:radius, ry:radius, fill:s.color, opacity:0.9});
      if(w>60) label(s.text, x+8, y+18, "start", 12);
      x += w + 1;
    });

    label(caption, left, y+46, "start", 12);
  }

  // Titre align√© sur la nouvelle marge
  label("Histogramme par segment (ventilation des kWh)", 160, 26, "start", 14);

  const capS1 = `S1 (avant AP1) : du ${fmtDate(ds)} au ${fmtDate(da1)} ‚Üí ${safe(q1)} kWh, 100 % p√®re.`;
  const capS2 = `S2 (AP1 ‚Üí AP2) : du ${fmtDate(da1)} au ${fmtDate(da2)} ‚Üí ${safe(q2)} kWh dont ${safe(p1)} p√®re & ${safe(c1)} fils.`;
  const capS3 = `S3 (apr√®s AP2) : du ${fmtDate(da2)} au ${fmtDate(de)} ‚Üí ${safe(q3)} kWh dont ${safe(p2)} p√®re, ${safe(c2)} fils, ${safe(g2)} petit-fils.`;

  barRow(60,  [{w:q1, color:"var(--col-pere)", text:`p√®re ${safe(q1)}`}], "S1 (avant AP1)", q1, capS1);
  barRow(130, [{w:p1, color:"var(--col-pere)", text:`p√®re ${safe(p1)}`},{w:c1, color:"var(--col-fils)", text:`fils ${safe(c1)}`}], "S2 (AP1 ‚Üí AP2)", q2, capS2);
  barRow(200, [{w:p2, color:"var(--col-pere)", text:`p√®re ${safe(p2)}`},{w:c2, color:"var(--col-fils)", text:`fils ${safe(c2)}`},{w:g2, color:"var(--col-petit)", text:`petit-fils ${safe(g2)}`}], "S3 (apr√®s AP2)", q3, capS3);

  const tot = safe(q1)+safe(q2)+safe(q3);
  label(`Total p√©riode : ${tot} kWh`, 160, 270, "start", 13);
}

function compute2(){
  const FS=fStart2.value, FE=fEnd2.value;
  const ds=dStart2.value, da1=dAP21.value, da2=dAP22.value, de=dEnd2.value;
  const S=asNum(iStart2.value), A1=asNum(iAP21.value), A2=asNum(iAP22.value), E=asNum(iEnd2.value);
  const k1=asNum(coef21_pere.value), k2p=asNum(coef22_pere.value), k2f=asNum(coef22_fils.value), k2c=asNum(coef22_petit.value);

  const validOrder=(ds&&da1&&da2&&de)
    ? (new Date(ds)<=new Date(da1) && new Date(da1)<=new Date(da2) && new Date(da2)<=new Date(de) && S<=A1 && A1<=A2 && A2<=E)
    : false;

  const coefsOK2 = [k2p,k2f,k2c].every(x=>x>=0 && x<=1) && Math.abs((k2p+k2f+k2c)-1)<1e-6;

  let q1=NaN,q2=NaN,q3=NaN,p1=NaN,c1=NaN,p2=NaN,c2=NaN,g2=NaN,totP=NaN;
  let okSeg2=false, okSeg3=false, okDelta=false;
  const ready = ds&&da1&&da2&&de && [S,A1,A2,E].every(Number.isFinite) && Number.isFinite(k1) && coefsOK2 && validOrder;

  if(ready){
    q1=A1-S; q2=A2-A1; q3=E-A2;
    p1=Math.round(q2*k1); c1=q2-p1;
    p2=Math.round(q3*k2p); c2=Math.round(q3*k2f); g2=q3-p2-c2;
    totP=q1+p1+p2;

    okSeg2 = (p1 + c1 === q2);
    okSeg3 = (p2 + c2 + g2 === q3);
    okDelta = ((E - S) === (q1 + q2 + q3));
  }

  drawTimeline(timeline2,[
    {tag:"fstart", d:FS?new Date(FS):null},
    {tag:"fend",   d:FE?new Date(FE):null},
    {d:ds?new Date(ds):null,  idx:S},
    {d:da1?new Date(da1):null,idx:A1},
    {d:da2?new Date(da2):null,idx:A2},
    {d:de?new Date(de):null,  idx:E},
    {d:(ds&&da1)?new Date((+new Date(ds)+(+new Date(da1)))/2):null,lbl:"S1 : 100 % p√®re"},
    {d:(da1&&da2)?new Date((+new Date(da1)+(+new Date(da2)))/2):null,lbl:(Number.isFinite(k1)?`S2 : ${pctText(k1)} % p√®re`:"S2")},
    {d:(da2&&de)?new Date((+new Date(da2)+(+new Date(de)))/2):null,lbl:(coefsOK2?`S3 : ${pctText(k2p)} % p√®re`:"S3")}
  ]);

  // On passe aussi les dates pour les l√©gendes sous barres
  drawStackedPF2(bars2, { q1,q2,q3,p1,c1,p2,c2,g2, ds, da1, da2, de });

  if (ready){
    let line = [
      `BAP : AP1 au ${fmtDate(da1)} (index ${A1}) puis AP2 au ${fmtDate(da2)} (index ${A2})`,
      `; avant AP1 : ${A1} - ${S} = ${q1}`,
      `; entre AP1 et AP2 : ${A2} - ${A1} = ${q2} √ó ${pctText(k1)} % = ${p1}`,
      `; apr√®s AP2 : ${E} - ${A2} = ${q3} √ó ${pctText(k2p)} % = ${p2}`,
      `‚áí quantit√© attendue (p√®re) = ${q1} + ${p1} + ${p2}`
    ].join(" ");
    const pStr=(price2.value||"").trim(), pNum=asNum(pStr);
    bap2.value = (pStr && Number.isFinite(pNum))
      ? `${line} soit ${totP} √ó ${pStr} = ${(totP*pNum).toLocaleString("fr-FR",{minimumFractionDigits:2,maximumFractionDigits:2})}‚Ç¨`
      : line;
  } else {
    bap2.value = "";
  }

  renderChroniqueLive2({FS,FE,ds,S,da1,A1,da2,A2,de,E,k1,k2p,k2f,k2c,
                        q1,q2,q3,p1,c1,p2,c2,g2,totP,
                        validOrder, coefsOK2, okSeg2, okSeg3, okDelta, ready});
}

/* =================== Listeners & INIT =================== */
window.addEventListener('DOMContentLoaded', ()=>{
  /* PF1 */
  [fStart1,fEnd1,dStart1,iStart1,dAP1,iAP1,dEnd1,iEnd1,coef1,price1].forEach(el=>el.addEventListener('input', compute1));
  document.getElementById('exA1').addEventListener('click', ()=>{
    fStart1.value="2024-03-05"; fEnd1.value="2025-03-05";
    dStart1.value="2024-03-05"; iStart1.value="12000";
    dAP1.value="2024-08-20";   iAP1.value="18450";
    dEnd1.value="2025-03-05";  iEnd1.value="25380";
    coef1.value="0.70";        price1.value="0.10";
    compute1();
  });
  document.getElementById('exB1').addEventListener('click', ()=>{
    fStart1.value="2019-10-24"; fEnd1.value="2020-10-23";
    dStart1.value="2019-10-24"; iStart1.value="0";
    dAP1.value="2020-05-27";   iAP1.value="1715";
    dEnd1.value="2020-10-23";  iEnd1.value="3112";
    coef1.value="0.80";        price1.value="";
    compute1();
  });
  document.getElementById('clear1').addEventListener('click', ()=>{
    [fStart1,fEnd1,dStart1,iStart1,dAP1,iAP1,dEnd1,iEnd1,coef1,price1].forEach(el=>el.value="");
    document.getElementById('chroniqueLive1').innerHTML=""; timeline1.innerHTML=""; bap1.value="";
  });
  document.getElementById('copy1').addEventListener('click', ()=>{ bap1.select(); document.execCommand('copy'); });

  /* PF2 */
  [fStart2,fEnd2,dStart2,iStart2,dAP21,iAP21,dAP22,iAP22,dEnd2,iEnd2,
   coef21_pere,coef22_pere,coef22_fils,coef22_petit,price2
  ].forEach(el=>el.addEventListener('input', compute2));

  document.getElementById('ex2').addEventListener('click', ()=>{
    fStart2.value="2024-01-01";  fEnd2.value="2024-12-31";
    dStart2.value="2024-01-01";  iStart2.value="5000";
    dAP21.value="2024-04-01";    iAP21.value="6200";
    dAP22.value="2024-09-15";    iAP22.value="9100";
    dEnd2.value="2024-12-31";    iEnd2.value="11200";
    coef21_pere.value="0.70";
    coef22_pere.value="0.60"; coef22_fils.value="0.25"; coef22_petit.value="0.15";
    price2.value="0.10";
    compute2();
  });

  document.getElementById('clear2').addEventListener('click', ()=>{
    [fStart2,fEnd2,dStart2,iStart2,dAP21,iAP21,dAP22,iAP22,dEnd2,iEnd2,
     coef21_pere,coef22_pere,coef22_fils,coef22_petit,price2
    ].forEach(el=>el.value="");
    chrono2.innerHTML=""; timeline2.innerHTML=""; bars2.innerHTML=""; bap2.value="";
  });

  document.getElementById('copy2').addEventListener('click', ()=>{ bap2.select(); document.execCommand('copy'); });

  /* D√©marrage : on charge l‚Äôexemple 1 AP pour montrer le flux */
  document.getElementById('exA1').click();
});
</script>
</body>
</html>
