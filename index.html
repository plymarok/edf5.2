<!DOCTYPE html>
<html lang="fr" data-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AP ‚Äî BAP norm√©, Ligne de vie & P√©riode de facturation</title>
  <meta name="color-scheme" content="light dark" />
  <style>
    :root{
      --bg:#f7f7fb; --panel:#ffffff; --text:#16161b; --muted:#6b7280;
      --accent:#4f46e5; --accent-weak:#eef2ff;
      --ok:#10b981; --ko:#ef4444; --warn:#f59e0b;
      --border:#e7e7ef; --shadow:0 10px 26px rgba(16,24,40,.06);
    }
    html[data-theme="dark"]{
      --bg:#0f1115; --panel:#161a22; --text:#e9e9f2; --muted:#9aa0aa;
      --accent:#8b93ff; --accent-weak:#1e2330; --border:#262b36; --shadow:0 12px 28px rgba(0,0,0,.45);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; background:var(--bg); color:var(--text);
      font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .topbar{position:sticky; top:0; z-index:10; display:flex; align-items:center; justify-content:space-between;
      padding:14px 18px; background:var(--panel); border-bottom:1px solid var(--border); box-shadow:var(--shadow)}
    .topbar h1{font-size:18px; margin:0}
    .actions{display:flex; gap:10px; align-items:center}
    .btn{border-radius:10px; border:1px solid var(--border); background:var(--panel); color:var(--text); padding:10px 14px; cursor:pointer}
    .btn.primary{background:var(--accent); color:#fff; border-color:transparent}
    .btn.ghost{background:transparent}
    .control{background:transparent; border:1px solid var(--border); border-radius:10px; padding:10px 12px; color:var(--text); width:100%}
    .control:focus{outline:none; border-color:var(--accent); box-shadow:0 0 0 3px var(--accent-weak)}
    .container{max-width:1100px; margin:18px auto; padding:0 18px; display:grid; gap:18px}
    .panel{background:var(--panel); border:1px solid var(--border); border-radius:14px; padding:16px 16px 20px; box-shadow:var(--shadow)}
    .grid{display:grid; grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); gap:12px}
    .row{display:grid; grid-template-columns:210px 1fr; gap:10px; align-items:center; margin:8px 0}
    .muted{color:var(--muted)}
    .mono{font-variant-numeric:tabular-nums}
    .pill{padding:6px 10px; border-radius:999px; background:var(--accent-weak)}
    textarea{width:100%; min-height:120px; resize:vertical; border-radius:10px; border:1px solid var(--border); padding:10px}
    svg.timeline{width:100%; height:190px}
    .small{font-size:13px}
    .note{margin-top:6px; font-size:13px}
    .warn{color:var(--warn)}
  </style>
</head>
<body>
  <header class="topbar">
    <h1>Augmentation de puissance ‚Äî BAP norm√©, Ligne de vie & P√©riode</h1>
    <div class="actions">
      <button id="exA" class="btn">Charger exemple (80%)</button>
      <button id="exB" class="btn">Charger exemple (70%)</button>
      <button id="theme" class="btn ghost">üåô/‚òÄÔ∏è</button>
    </div>
  </header>

  <main class="container">
    <section class="panel">
      <h3>1) Renseigne le cas</h3>
      <div class="grid">
        <div>
          <h4>P√©riode de facturation (la facture que tu traites)</h4>
          <div class="row"><label>D√©but de p√©riode</label><input id="fStart" type="date" class="control"></div>
          <div class="row"><label>Fin de p√©riode</label><input id="fEnd" type="date" class="control"></div>

          <h4 style="margin-top:10px">Trois jalons d‚Äôindex</h4>
          <div class="row"><label>Fin de facture N-1</label><input id="dStart" type="date" class="control"></div>
          <div class="row"><label>Index √† cette date</label><input id="iStart" type="number" step="1" class="control" placeholder="ex. 0"></div>
          <div class="row"><label>Date d‚ÄôAP</label><input id="dAP" type="date" class="control"></div>
          <div class="row"><label>Index le jour d‚ÄôAP</label><input id="iAP" type="number" step="1" class="control" placeholder="ex. 1715"></div>
          <div class="row"><label>Date anniversaire</label><input id="dEnd" type="date" class="control"></div>
          <div class="row"><label>Index √† l‚Äôanniversaire</label><input id="iEnd" type="number" step="1" class="control" placeholder="ex. 3112"></div>

          <div class="row"><label>Coef p√®re apr√®s AP</label>
            <div style="display:flex; gap:8px; align-items:center">
              <input id="coef" type="number" step="0.01" min="0" max="1" class="control" placeholder="0.80 = 80 %">
              <span class="muted small">0,6974 ‚áí 69,74&nbsp;%</span>
            </div>
          </div>
          <div class="row"><label>Prix (‚Ç¨/kWh) <span class="muted small">(facultatif)</span></label>
            <input id="price" type="text" class="control" placeholder="0.10">
          </div>
          <div class="note muted">Tol√©rance index d‚ÄôAP : <b>J ¬± 1</b> ‚Ä¢ Le fils prend <i>1 ‚àí coef p√®re</i> apr√®s AP.</div>
        </div>

        <div>
          <h4>Quantit√©s calcul√©es</h4>
          <div class="mono">
            <div>Q<sub>avant</sub> = <span id="q1">‚Äî</span> kWh (100 % p√®re)</div>
            <div>Q<sub>apr√®s</sub> = <span id="q2">‚Äî</span> kWh</div>
            <div>Part p√®re apr√®s = <span id="afterFather">‚Äî</span> kWh ‚Ä¢ Part fils apr√®s = <span id="afterChild">‚Äî</span> kWh</div>
            <div><b>Total p√®re attendu</b> = <span id="fatherTotal">‚Äî</span> kWh</div>
            <div id="checks" class="small muted" style="margin-top:4px"></div>
            <div id="periodWarn" class="small warn"></div>
          </div>

          <div id="badges" style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px"></div>
        </div>
      </div>

      <div id="timeline" style="margin-top:12px"></div>
    </section>

    <section class="panel">
      <h3>2) BAP (commentaire norm√© pr√™t √† copier)</h3>
      <textarea id="bap" class="mono" readonly></textarea>
      <div style="display:flex; gap:10px; margin-top:8px">
        <button id="copy" class="btn primary">Copier le BAP</button>
        <span class="muted small">Tol√©rance ¬± 1 kWh ‚Ä¢ Arrondi √† l‚Äôunit√© sur la part p√®re</span>
      </div>
    </section>
  </main>

  <script>
    // Th√®me
    (function(){
      const root=document.documentElement, key="ap-theme";
      const saved=localStorage.getItem(key); if(saved) root.setAttribute("data-theme", saved);
      document.getElementById("theme").onclick=()=>{
        const next = root.getAttribute("data-theme")==="dark"?"light":"dark";
        root.setAttribute("data-theme", next); localStorage.setItem(key, next);
      };
    })();

    // S√©lecteurs
    const fStart = document.getElementById('fStart');
    const fEnd   = document.getElementById('fEnd');

    const dStart = document.getElementById('dStart');
    const iStart = document.getElementById('iStart');
    const dAP    = document.getElementById('dAP');
    const iAP    = document.getElementById('iAP');
    const dEnd   = document.getElementById('dEnd');
    const iEnd   = document.getElementById('iEnd');
    const coef   = document.getElementById('coef');
    const price  = document.getElementById('price');

    const q1El = document.getElementById('q1');
    const q2El = document.getElementById('q2');
    const afterFatherEl = document.getElementById('afterFather');
    const afterChildEl  = document.getElementById('afterChild');
    const fatherTotalEl = document.getElementById('fa
