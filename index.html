<!DOCTYPE html>
<html lang="fr" data-theme="light">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Calcul norm√© ‚Äî AP P√®re & Fils / P√®re, Fils & Petit-fils</title>
<meta name="color-scheme" content="light dark" />
<style>
  :root{
    --bg:#f7f7fb; --panel:#fff; --text:#16161b; --muted:#6b7280;
    --accent:#4f46e5; --accent-weak:#eef2ff;
    --border:#e7e7ef; --shadow:0 10px 26px rgba(16,24,40,.06);
    /* Couleurs entit√©s (PF2) */
    --col-pere:#4f46e5; --col-fils:#10b981; --col-petit:#a855f7;
  }
  html[data-theme="dark"]{
    --bg:#0f1115; --panel:#161a22; --text:#e9e9f2; --muted:#9aa0aa;
    --accent:#8b93ff; --accent-weak:#1e2330; --border:#262b36; --shadow:0 12px 28px rgba(0,0,0,.45);
    --col-pere:#8b93ff; --col-fils:#34d399; --col-petit:#c084fc;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  .topbar{position:sticky;top:0;z-index:10;display:flex;align-items:center;justify-content:space-between;gap:12px;
    padding:14px 18px;background:var(--panel);border-bottom:1px solid var(--border);box-shadow:var(--shadow)}
  .topbar h1{font-size:18px;margin:0}
  .btn{border-radius:10px;border:1px solid var(--border);background:var(--panel);color:var(--text);padding:10px 14px;cursor:pointer}
  .btn.primary{background:var(--accent);color:#fff;border-color:transparent}
  .btn.ghost{background:transparent}

  /* Onglets (haut) */
  .tabs{display:flex;gap:8px;margin:16px auto;max-width:1100px;padding:0 18px}
  .tab{padding:10px 14px;border:1px solid var(--border);border-radius:10px;background:var(--panel);cursor:pointer}
  .tab.active{background:var(--accent);color:#fff;border-color:transparent}

  /* Contenu */
  .container{max-width:1100px;margin:0 auto 24px;padding:0 18px;display:grid;gap:18px}
  .panel{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:16px 16px 20px;box-shadow:var(--shadow)}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:14px}
  .row{display:grid;grid-template-columns:230px 1fr;gap:10px;align-items:center;margin:8px 0}
  .help{grid-column:2/3;font-size:12px;color:var(--muted);margin-top:-6px;margin-bottom:6px}
  .control{background:transparent;border:1px solid var(--border);border-radius:10px;padding:10px 12px;color:var(--text);width:100%}
  .control:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px var(--accent-weak)}
  textarea{width:100%;min-height:120px;resize:vertical;border-radius:10px;border:1px solid var(--border);padding:10px}
  svg.timeline{width:100%;height:210px}
  .muted{color:var(--muted)} .mono{font-variant-numeric:tabular-nums}
  .chroniqueLive{min-height:260px;border:1px solid var(--border);border-radius:12px;padding:14px;background:var(--panel)}
  .chroniqueLive h4{margin:6px 0 8px} .chroniqueLive p{margin:6px 0}
  .chip{display:inline-block;background:var(--accent-weak);padding:2px 8px;border-radius:999px}

  /* Panneaux d‚Äôonglet */
  .tab-panel{display:none}
  .tab-panel.active{display:grid}

  /* Mini-tabs PF2 (viz) */
  .mini-tabs{display:flex;gap:8px;margin:10px 0}
  .mini-tab{padding:6px 10px;border:1px solid var(--border);border-radius:8px;background:var(--panel);cursor:pointer;font-size:14px}
  .mini-tab.active{background:var(--accent);color:#fff;border-color:transparent}
  .viz-pane{display:none}
  .viz-pane.active{display:block}

  /* L√©gende PF2 */
  .legend{display:flex;gap:14px;align-items:center;font-size:13px;color:var(--muted);margin-top:8px}
  .swatch{width:12px;height:12px;border-radius:3px;display:inline-block}
  .sw-pere{background:var(--col-pere)} .sw-fils{background:var(--col-fils)} .sw-petit{background:var(--col-petit)}
</style>
</head>
<body>
<header class="topbar">
  <h1>Calcul norm√© ‚Äî Augmentations de puissance</h1>
  <div class="actions">
    <button id="theme" class="btn ghost" type="button">üåô/‚òÄÔ∏è</button>
  </div>
</header>

<nav class="tabs">
  <button class="tab active" data-panel="pf1" type="button">P√®re & Fils (1 AP)</button>
  <button class="tab" data-panel="pf2" type="button">P√®re, Fils & Petit-fils (2 AP)</button>
</nav>

<!-- =================== ONGLET 1 : P√àRE & FILS (1 AP) ‚Äî VERROUILL√â =================== -->
<main id="pf1" class="container tab-panel active">
  <section class="panel">
    <h3>1) Renseigne le cas ‚Äî P√®re & Fils (1 AP)</h3>
    <div class="grid">
      <div>
        <h4>P√©riode de facturation</h4>
        <div class="row"><label>D√©but</label><input id="fStart1" type="date" class="control"></div>
        <div class="row"><label>Fin</label><input id="fEnd1" type="date" class="control"></div>

        <h4 style="margin-top:12px">Jalons d‚Äôindex</h4>
        <div class="row"><label>Fin N-1</label><input id="dStart1" type="date" class="control"></div>
        <div class="row"><label>Index fin N-1</label><input id="iStart1" type="number" step="1" class="control" placeholder="ex. 0"></div>
        <div class="row"><label>Date d‚ÄôAP</label><input id="dAP1" type="date" class="control"></div>
        <div class="row"><label>Index AP</label><input id="iAP1" type="number" step="1" class="control" placeholder="ex. 1715"></div>
        <div class="row"><label>Anniversaire</label><input id="dEnd1" type="date" class="control"></div>
        <div class="row"><label>Index anniversaire</label><input id="iEnd1" type="number" step="1" class="control" placeholder="ex. 3112"></div>

        <h4 style="margin-top:12px">Coefficients</h4>
        <div class="row"><label>Coef p√®re apr√®s AP</label><input id="coef1" type="number" step="0.01" min="0" max="1" class="control" placeholder="0.70 = 70 %"></div>

        <div class="row"><label>Prix (‚Ç¨/kWh) <span class="muted">(optionnel)</span></label>
          <input id="price1" type="text" class="control" placeholder="0.10">
        </div>

        <div style="display:flex;gap:8px;margin-top:10px">
          <button id="exA1" class="btn" type="button">Exemple (70 %)</button>
          <button id="exB1" class="btn" type="button">Exemple (80 %)</button>
          <button id="clear1" class="btn" type="button">Vider</button>
        </div>
      </div>

      <div>
        <h4>Chronique (r√©sum√© en temps r√©el)</h4>
        <div id="chroniqueLive1" class="chroniqueLive"></div>
      </div>
    </div>
    <div id="timeline1" style="margin-top:14px"></div>
  </section>

  <section class="panel">
    <h3>2) BAP ‚Äî Commentaire norm√©</h3>
    <textarea id="bap1" class="mono" readonly></textarea>
    <div style="display:flex;gap:10px;margin-top:8px">
      <button id="copy1" class="btn primary" type="button">Copier le BAP</button>
      <span class="muted">Tol√©rance ¬± 1 kWh ‚Ä¢ Arrondi part p√®re</span>
    </div>
  </section>
</main>

<!-- =================== ONGLET 2 : P√àRE, FILS & PETIT-FILS (2 AP) ‚Äî AM√âLIOR√â =================== -->
<main id="pf2" class="container tab-panel">
  <section class="panel">
    <h3>1) Renseigne le cas ‚Äî P√®re, Fils & Petit-fils (2 AP)</h3>
    <div class="grid">
      <div>
        <h4>P√©riode de facturation</h4>
        <div class="row"><label>D√©but</label><input id="fStart2" type="date" class="control"></div>
        <div class="row"><label>Fin</label><input id="fEnd2" type="date" class="control"></div>

        <h4 style="margin-top:12px">Jalons d‚Äôindex</h4>
        <div class="row"><label>Fin N-1</label><input id="dStart2" type="date" class="control"></div>
        <div class="row"><label>Index fin N-1</label><input id="iStart2" type="number" step="1" class="control"></div>

        <div class="row"><label>Date AP1</label><input id="dAP21" type="date" class="control"></div>
        <div class="row"><label>Index AP1</label><input id="iAP21" type="number" step="1" class="control"></div>

        <div class="row"><label>Date AP2</label><input id="dAP22" type="date" class="control"></div>
        <div class="row"><label>Index AP2</label><input id="iAP22" type="number" step="1" class="control"></div>

        <div class="row"><label>Anniversaire</label><input id="dEnd2" type="date" class="control"></div>
        <div class="row"><label>Index anniversaire</label><input id="iEnd2" type="number" step="1" class="control"></div>

        <h4 style="margin-top:12px">Coefficients</h4>
        <div class="row"><label>AP1‚ÜíAP2 : coef p√®re</label><input id="coef21_pere" type="number" step="0.01" min="0" max="1" class="control" placeholder="0.70"></div>
        <div class="row"><label>Apr√®s AP2 : p√®re</label><input id="coef22_pere" type="number" step="0.01" min="0" max="1" class="control" placeholder="0.60"></div>
        <div class="row"><label>Apr√®s AP2 : fils</label><input id="coef22_fils" type="number" step="0.01" min="0" max="1" class="control" placeholder="0.25"></div>
        <div class="row"><label>Apr√®s AP2 : petit-fils</label><input id="coef22_petit" type="number" step="0.01" min="0" max="1" class="control" placeholder="0.15"></div>

        <div class="row"><label>Prix (‚Ç¨/kWh) <span class="muted">(optionnel)</span></label><input id="price2" type="text" class="control" placeholder="0.10"></div>

        <div style="display:flex;gap:8px;margin-top:10px">
          <button id="ex2" class="btn" type="button">Exemple 2 AP</button>
          <button id="clear2" class="btn" type="button">Vider</button>
        </div>
      </div>

      <div>
        <h4>Chronique (r√©sum√© en temps r√©el)</h4>
        <div id="chroniqueLive2" class="chroniqueLive"></div>
      </div>
    </div>

    <!-- Mini onglets de visualisation -->
    <div class="mini-tabs">
      <button class="mini-tab active" data-viz="time2" type="button">Ligne de vie</button>
      <button class="mini-tab" data-viz="stack2" type="button">Histogramme par segment</button>
    </div>
    <div id="viz-time2" class="viz-pane active"><div id="timeline2"></div></div>
    <div id="viz-stack2" class="viz-pane"><div id="timeline2bars"></div>
      <div class="legend">
        <span class="swatch sw-pere"></span> p√®re
        <span class="swatch sw-fils"></span> fils
        <span class="swatch sw-petit"></span> petit-fils
      </div>
    </div>
  </section>

  <section class="panel">
    <h3>2) BAP ‚Äî Commentaire norm√©</h3>
    <textarea id="bap2" class="mono" readonly></textarea>
    <div style="display:flex;gap:10px;margin-top:8px">
      <button id="copy2" class="btn primary" type="button">Copier le BAP</button>
      <span class="muted">Apr√®s AP2, les 3 coefficients doivent sommer 1</span>
    </div>
  </section>
</main>

<script>
/* =================== Th√®me =================== */
(function(){
  const root=document.documentElement, key="ap-theme";
  const saved=localStorage.getItem(key); if(saved) root.setAttribute("data-theme", saved);
  document.getElementById("theme").onclick=()=>{
    const next=root.getAttribute("data-theme")==="dark"?"light":"dark";
    root.setAttribute("data-theme", next); localStorage.setItem(key,next);
  };
})();

/* =================== Onglets =================== */
document.querySelectorAll('.tabs .tab').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    document.querySelectorAll('.tabs .tab').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    document.querySelectorAll('.tab-panel').forEach(p=>p.classList.remove('active'));
    document.getElementById(btn.dataset.panel).classList.add('active');
  });
});

/* =================== Helpers communs =================== */
const i18n = n => Number(n).toLocaleString("fr-FR");
const raw  = n => String(n);
const fmt  = s => s ? new Date(s+"T00:00:00").toLocaleDateString("fr-FR") : "";
const asNum = v => (v===""||v==null)? NaN : Number(String(v).replace(",","."));
const pctText = x => (x*100).toLocaleString("fr-FR",{maximumFractionDigits:2}).replace(/\u00a0/g," ");
const diffDays=(a,b)=>Math.round((new Date(b)-new Date(a))/(1000*3600*24));
function guessPeriodLabel(a,b){
  if(!(a&&b)) return "";
  const d=diffDays(a,b);
  if(d>=330) return "p√©riode annuelle";
  if(d>=170 && d<=200) return "p√©riode semestrielle";
  return `p√©riode de ${d} jours`;
}
function drawTimeline(host, marks){
  host.innerHTML="";
  const svgNS="http://www.w3.org/2000/svg";
  const svg=document.createElementNS(svgNS,"svg");
  svg.setAttribute("class","timeline");
  svg.setAttribute("viewBox","0 0 1100 210");
  svg.setAttribute("preserveAspectRatio","xMidYMid meet");
  host.appendChild(svg);

  const valid=marks.filter(m=>m.d);
  if(valid.length<2){
    const p=document.createElement("div");
    p.className="muted"; p.textContent="Renseigne la p√©riode et les jalons : la ligne de vie se dessine.";
    host.appendChild(p); return;
  }
  valid.sort((a,b)=>a.d-b.d);
  const min=valid[0].d, max=valid[valid.length-1].d;
  const span=Math.max(1,(max-min));
  const X=d=>40+((d-min)/span)*1020;

  function N(tag,attrs){const n=document.createElementNS(svgNS,tag);for(const k in attrs)n.setAttribute(k,attrs[k]);svg.appendChild(n);return n;}
  function vmark(x){N("line",{x1:x,y1:70,x2:x,y2:110,stroke:"currentColor","stroke-width":3});}
  function text(t,x,y,anchor="start",size=14){const n=N("text",{x,y,"text-anchor":anchor,"font-size":size}); n.textContent=t;}

  const fstart=marks.find(m=>m.tag==="fstart"), fend=marks.find(m=>m.tag==="fend");
  if(fstart && fend){
    const x1=X(fstart.d), x2=X(fend.d);
    N("rect",{x:Math.min(x1,x2),y:78,width:Math.abs(x2-x1),height:24,fill:"var(--accent-weak)",opacity:"0.6"});
    text("P√©riode de facturation",(x1+x2)/2,66,"middle",12);
  }

  // Axe
  N("line",{x1:X(valid[0].d),y1:90,x2:X(valid[valid.length-1].d),y2:90,stroke:"#2a63e7","stroke-width":6,"stroke-linecap":"round"});

  valid.forEach(m=>{
    const x=X(m.d); vmark(x);
    text(fmt(m.d.toISOString().slice(0,10)),x,36,"middle");
    if(Number.isFinite(m.idx)) text(raw(m.idx),x,140,"middle");
    if(m.lbl) text(m.lbl,x,168,"middle",12);
  });
}

/* =================== ONGLET 1 : P√àRE & FILS ‚Äî INCHANG√â =================== */
const fStart1=document.getElementById('fStart1'), fEnd1=document.getElementById('fEnd1');
const dStart1=document.getElementById('dStart1'), iStart1=document.getElementById('iStart1');
const dAP1=document.getElementById('dAP1'), iAP1=document.getElementById('iAP1');
const dEnd1=document.getElementById('dEnd1'), iEnd1=document.getElementById('iEnd1');
const coef1=document.getElementById('coef1'), price1=document.getElementById('price1');
const timeline1=document.getElementById('timeline1'), bap1=document.getElementById('bap1');
let chroniqueLive = document.getElementById('chroniqueLive1');

function renderChroniqueLive(values){
  const { FS, FE, ds, S, da, A, de, E, k, q1, q2, fatherAfter, childAfter, fatherTotal, validOrder, ok1, ok2, ready } = values;
  const L = [];
  if (FS && FE) {
    L.push(`<h4>Le cadre</h4>
       <p>Rideau lev√© sur la <span class="chip">${guessPeriodLabel(FS,FE)}</span> :
       du <b>${fmt(FS)}</b> au <b>${fmt(FE)}</b>, c‚Äôest dans cet intervalle que se joue la r√©partition
       entre <i>p√®re</i> et <i>fils</i>.</p>`);
  } else {
    L.push(`<h4>Le cadre</h4><p class="muted">Indique le d√©but et la fin de la facture : je poserai ensuite les jalons et d√©roulerai le calcul.</p>`);
  }
  const jalons = [];
  if (ds) jalons.push(`√† la <b>cl√¥ture pr√©c√©dente</b> (${fmt(ds)}), l‚Äôindex du p√®re est <b>${Number.isFinite(S)?String(S):"?"}</b> kWh`);
  if (da) jalons.push(`le <b>jour de l‚ÄôAP</b> (${fmt(da)}), on rel√®ve <b>${Number.isFinite(A)?String(A):"?"}</b> kWh`);
  if (de) jalons.push(`√† la <b>date anniversaire</b> (${fmt(de)}), l‚Äôindex affiche <b>${Number.isFinite(E)?String(E):"?"}</b> kWh`);
  L.push(jalons.length ? `<p>Trois rep√®res structurent l‚Äôhistoire : ${jalons.join(" ; ")}.</p>` : `<p class="muted">J‚Äôattends les trois rep√®res : fin N-1 ‚Üí AP ‚Üí anniversaire.</p>`);
  if (da && de) {
    if (k >= 0 && k <= 1) {
      L.push(`<p>√Ä compter de l‚ÄôAP, la production se partage avec constance :
         <b>${pctText(k)} %</b> au p√®re et <b>${pctText(1-k)} %</b> au fils.
         Avant cette date, le p√®re est seul √† bord.</p>`);
    } else {
      L.push(`<p class="muted">Renseigne le <b>coefficient du p√®re</b> apr√®s AP (entre 0 et 1) pour ventiler correctement.</p>`);
    }
  }
  if (ready) {
    L.push(`<h4>Ce que disent les compteurs</h4>
       <p>De la fin N-1 √† l‚ÄôAP : <b>${A} ‚àí ${S} = ${q1} kWh</b> int√©gralement au p√®re.</p>
       <p>De l‚ÄôAP √† l‚Äôanniversaire : <b>${E} ‚àí ${A} = ${q2} kWh</b>, ventil√©s en
       <b>${fatherAfter} kWh</b> (p√®re) et <b>${childAfter} kWh</b> (fils).</p>
       <p><b>Verdict pour le p√®re :</b> <b>${fatherTotal} kWh</b> attendus sur la facture.</p>`);
    L.push(`<p>${ok1 ? "‚úÖ" : "‚ùå"} Les parts <i>p√®re</i> et <i>fils</i> recomposent bien <i>Q_apr√®s</i> ;
       ${ok2 ? "‚úÖ" : "‚ùå"} <i>Q_avant + Q_apr√®s</i> recolle exactement √† <i>Œîindex</i>.
       Autrement dit, les chiffres s‚Äôaccordent avec le r√©cit.</p>`);
  } else if (ds && da && de && !validOrder) {
    L.push(`<p class="ko">‚ö† L‚Äôintrigue se brouille : l‚Äôordre chronologique doit rester limpide
       (<b>fin N-1 ‚â§ AP ‚â§ anniversaire</b>) et les index doivent √™tre croissants.</p>`);
  }
  if (!ready) {
    const manques = [];
    if (!FS || !FE) manques.push("p√©riode de facturation");
    if (!ds || !Number.isFinite(S)) manques.push("index de fin N-1");
    if (!da || !Number.isFinite(A)) manques.push("index le jour d‚ÄôAP");
    if (!de || !Number.isFinite(E)) manques.push("index √† l‚Äôanniversaire");
    if (!(k>=0 && k<=1)) manques.push("coefficient du p√®re apr√®s AP");
    if (manques.length){ L.push(`<p class="muted">Pour achever le tableau : ${manques.join(" ‚Ä¢ ")}.</p>`); }
  }
  chroniqueLive.innerHTML = L.join("");
}
function compute1(){
  chroniqueLive = document.getElementById('chroniqueLive1');
  const FS=fStart1.value, FE=fEnd1.value;
  const ds=dStart1.value, da=dAP1.value, de=dEnd1.value;
  const S=asNum(iStart1.value), A=asNum(iAP1.value), E=asNum(iEnd1.value);
  const k=asNum(coef1.value);
  const validOrder = (ds && da && de) ? (new Date(ds)<=new Date(da) && new Date(da)<=new Date(de) && S<=A && A<=E) : false;
  let q1=NaN,q2=NaN,fatherAfter=NaN,childAfter=NaN,fatherTotal=NaN, ok1=false, ok2=false;
  const ready = ds && da && de && [S,A,E].every(Number.isFinite) && (k>=0 && k<=1) && validOrder;
  if(ready){
    q1=A-S; q2=E-A;
    fatherAfter=Math.round(q2*k); childAfter=q2-fatherAfter; fatherTotal=q1+fatherAfter;
    ok1=(fatherAfter+childAfter===q2); ok2=((E-S)===(q1+q2));
  }
  drawTimeline(timeline1,[
    {tag:"fstart",d:FS?new Date(FS):null},
    {tag:"fend",d:FE?new Date(FE):null},
    {d:ds?new Date(ds):null,idx:S},
    {d:da?new Date(da):null,idx:A},
    {d:de?new Date(de):null,idx:E},
    {d:ds&&da?new Date((+new Date(ds)+new Date(da))/2):null,lbl:"100 % p√®re"},
    {d:da&&de?new Date((+new Date(da)+new Date(de))/2):null,lbl:(k>=0&&k<=1?`${pctText(k)} % p√®re`:"")}
  ]);
  const coefPct=pctText(k);
  if(ready){
    let line = `BAP : augmentation de puissance au ${fmt(da)} (index ${raw(A)}) ` +
               `; avant AP : ${raw(A)} - ${raw(S)} = ${raw(q1)} ` +
               `; apr√®s AP : ${raw(E)} - ${raw(A)} = ${raw(q2)} √ó ${coefPct} % = ${raw(fatherAfter)} ` +
               `=> quantit√© attendue de la facture = ${raw(q1)} + ${raw(fatherAfter)}`;
    const pStr=(price1.value||"").trim(), pNum=asNum(pStr);
    if(pStr && Number.isFinite(pNum)){
      const amount=(fatherTotal*pNum).toLocaleString("fr-FR",{minimumFractionDigits:2,maximumFractionDigits:2});
      line += ` soit ${raw(fatherTotal)} √ó ${pStr} = ${amount}‚Ç¨`;
    }
    bap1.value=line;
  } else { bap1.value=""; }
  renderChroniqueLive({FS,FE,ds,S,da,A,de,E,k,q1,q2,fatherAfter,childAfter,fatherTotal,validOrder,ok1,ok2,ready});
}

/* =================== ONGLET 2 : P√àRE, FILS & PETIT-FILS ‚Äî AM√âLIOR√â =================== */
const fStart2=document.getElementById('fStart2'), fEnd2=document.getElementById('fEnd2');
const dStart2=document.getElementById('dStart2'), iStart2=document.getElementById('iStart2');
const dAP21=document.getElementById('dAP21'), iAP21=document.getElementById('iAP21');
const dAP22=document.getElementById('dAP22'), iAP22=document.getElementById('iAP22');
const dEnd2=document.getElementById('dEnd2'), iEnd2=document.getElementById('iEnd2');
const coef21_pere=document.getElementById('coef21_pere');
const coef22_pere=document.getElementById('coef22_pere');
const coef22_fils=document.getElementById('coef22_fils');
const coef22_petit=document.getElementById('coef22_petit');
const price2=document.getElementById('price2');
const timeline2=document.getElementById('timeline2'), bap2=document.getElementById('bap2');
const chrono2=document.getElementById('chroniqueLive2');
const bars2=document.getElementById('timeline2bars');

/* Mini-tabs de visualisation PF2 */
document.querySelectorAll('.mini-tab').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    document.querySelectorAll('.mini-tab').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    document.querySelectorAll('.viz-pane').forEach(p=>p.classList.remove('active'));
    document.getElementById('viz-'+btn.dataset.viz).classList.add('active');
  });
});

function renderChroniqueLive2(v){
  const {FS,FE,ds,S,da1,A1,da2,A2,de,E,k1,k2p,k2f,k2c,
         q1,q2,q3,p1,c1,p2,c2,g2,totP,
         validOrder, coefsOK2, okSeg2, okSeg3, okDelta, ready} = v;

  const L=[];
  // Cadre
  if (FS && FE){
    L.push(`<h4>Le cadre</h4>
      <p>Du <b>${fmt(FS)}</b> au <b>${fmt(FE)}</b> ‚Äî une <span class="chip">${guessPeriodLabel(FS,FE)}</span> scand√©e par deux augmentations (AP1, AP2).</p>`);
  } else {
    L.push(`<h4>Le cadre</h4><p class="muted">Renseigne le d√©but et la fin de p√©riode.</p>`);
  }

  // Rep√®res
  const R=[];
  if (ds)  R.push(`fin N-1 ${fmt(ds)} : <b>${Number.isFinite(S)?S:"?"}</b>`);
  if (da1) R.push(`AP1 ${fmt(da1)} : <b>${Number.isFinite(A1)?A1:"?"}</b>`);
  if (da2) R.push(`AP2 ${fmt(da2)} : <b>${Number.isFinite(A2)?A2:"?"}</b>`);
  if (de)  R.push(`anniv. ${fmt(de)} : <b>${Number.isFinite(E)?E:"?"}</b>`);
  L.push(R.length?`<p>Quatre rep√®res jalonnent l‚Äôhistoire : ${R.join(" ‚Ä¢ ")}.</p>`:`<p class="muted">Rep√®res attendus : fin N-1 ‚Üí AP1 ‚Üí AP2 ‚Üí anniversaire.</p>`);

  // M√©canique de r√©partition
  if (da1 && da2) L.push(`<p><b>Segment 2 (AP1‚ÜíAP2)</b> : p√®re <b>${pctText(k1)} %</b>, fils <b>${pctText(1-k1)} %</b>.</p>`);
  if (de){
    if (coefsOK2){
      L.push(`<p><b>Segment 3 (apr√®s AP2)</b> : p√®re <b>${pctText(k2p)} %</b> ‚Ä¢ fils <b>${pctText(k2f)} %</b> ‚Ä¢ petit-fils <b>${pctText(k2c)} %</b> ‚Äî somme <b>100 %</b>.</p>`);
    } else {
      L.push(`<p class="muted">Apr√®s AP2, indique trois coefficients dans [0,1] qui somment 1.</p>`);
    }
  }

  // D√©composition lisible
  if (ready){
    L.push(`<h4>D√©composition des quantit√©s</h4>
      <p><b>S1 ‚Äî Avant AP1 :</b> ${A1} ‚àí ${S} = <b>${q1} kWh</b> (100 % p√®re).</p>
      <p><b>S2 ‚Äî AP1 ‚Üí AP2 :</b> ${A2} ‚àí ${A1} = <b>${q2} kWh</b> ‚Üí p√®re <b>${p1}</b> ‚Ä¢ fils <b>${c1}</b>.</p>
      <p><b>S3 ‚Äî Apr√®s AP2 :</b> ${E} ‚àí ${A2} = <b>${q3} kWh</b> ‚Üí p√®re <b>${p2}</b> ‚Ä¢ fils <b>${c2}</b> ‚Ä¢ petit-fils <b>${g2}</b>.</p>
      <p><b>Total p√®re attendu :</b> <b>${totP} kWh</b>.</p>`);

    L.push(`<p>${okSeg2?"‚úÖ":"‚ùå"} S2 : parts = Q‚ÇÇ ‚Ä¢ ${okSeg3?"‚úÖ":"‚ùå"} S3 : parts = Q‚ÇÉ ‚Ä¢ ${okDelta?"‚úÖ":"‚ùå"} S1+S2+S3 = Œîindex.</p>`);
  } else if (ds && da1 && da2 && de && !validOrder){
    L.push(`<p class="ko">‚ö† Ordre incoh√©rent : fin N-1 ‚â§ AP1 ‚â§ AP2 ‚â§ anniversaire et index croissants requis.</p>`);
  }

  // Manques
  if (!ready){
    const miss=[];
    if(!FS||!FE) miss.push("p√©riode");
    if(!ds||!Number.isFinite(S)) miss.push("index fin N-1");
    if(!da1||!Number.isFinite(A1)) miss.push("index AP1");
    if(!da2||!Number.isFinite(A2)) miss.push("index AP2");
    if(!de||!Number.isFinite(E)) miss.push("index anniversaire");
    if(!(k1>=0&&k1<=1)) miss.push("coef p√®re AP1‚ÜíAP2");
    if(!coefsOK2) miss.push("coefs p√®re/fils/petit-fils apr√®s AP2 (somme 1)");
    if(miss.length) L.push(`<p class="muted">√Ä compl√©ter : ${miss.join(" ‚Ä¢ ")}.</p>`);
  }

  chrono2.innerHTML=L.join("");
}

// Histogramme empil√© par segment (PF2)
function drawStackedPF2(host, data){
  host.innerHTML="";
  const {q1,q2,q3,p1,c1,p2,c2,g2} = data;
  const total = [q1,q2,q3].reduce((a,b)=>a+(Number.isFinite(b)?b:0),0);
  const svgNS="http://www.w3.org/2000/svg";
  const svg=document.createElementNS(svgNS,"svg");
  svg.setAttribute("viewBox","0 0 1100 230");
  svg.setAttribute("preserveAspectRatio","xMidYMid meet");
  host.appendChild(svg);

  function N(tag,attrs){const n=document.createElementNS(svgNS,tag);for(const k in attrs)n.setAttribute(k,attrs[k]);svg.appendChild(n);return n;}
  function label(t,x,y,anchor="start",size=13){const n=N("text",{x,y,"text-anchor":anchor,"font-size":size,fill:"currentColor"}); n.textContent=t;}
  function barRow(y, segments, title, qty){
    // segments: [{w:number, color:string, text:string}]
    const left=60, right=1040, width=right-left, height=28, radius=6;
    const sumW=segments.reduce((s,s1)=>s+s1.w,0)||1;
    let x=left;
    // titre + quantit√© √† gauche
    label(`${title}`, left-10, y+20, "end", 13);
    label(`${qty} kWh`, right+10, y+20, "start", 13);
    segments.forEach(s=>{
      const w = width*(s.w/sumW);
      if(w<=0) return;
      N("rect",{x, y, width:w, height, rx:radius, ry:radius, fill:s.color, opacity:0.9});
      if(w>60) label(s.text, x+8, y+18, "start", 12);
      x += w + 1;
    });
  }

  // En-t√™tes
  label("Histogramme par segment (ventilation des kWh)", 60, 26, "start", 14);

  // Lignes
  const row1Y=50, row2Y=100, row3Y=150;
  // S1 : 100% p√®re
  barRow(row1Y, [
    {w:q1, color:"var(--col-pere)", text:`p√®re ${q1}`}
  ], "S1 (avant AP1)", Number.isFinite(q1)?q1:0);

  // S2 : p√®re / fils
  barRow(row2Y, [
    {w:p1, color:"var(--col-pere)", text:`p√®re ${p1}`},
    {w:c1, color:"var(--col-fils)", text:`fils ${c1}`}
  ], "S2 (AP1 ‚Üí AP2)", Number.isFinite(q2)?q2:0);

  // S3 : p√®re / fils / petit-fils
  barRow(row3Y, [
    {w:p2, color:"var(--col-pere)", text:`p√®re ${p2}`},
    {w:c2, color:"var(--col-fils)", text:`fils ${c2}`},
    {w:g2, color:"var(--col-petit)", text:`petit-fils ${g2}`}
  ], "S3 (apr√®s AP2)", Number.isFinite(q3)?q3:0);

  // Totaux
  label(`Total p√©riode : ${total} kWh`, 60, 200, "start", 13);
}

function compute2(){
  const FS=fStart2.value, FE=fEnd2.value;
  const ds=dStart2.value, da1=dAP21.value, da2=dAP22.value, de=dEnd2.value;
  const S=asNum(iStart2.value), A1=asNum(iAP21.value), A2=asNum(iAP22.value), E=asNum(iEnd2.value);
  const k1=asNum(coef21_pere.value), k2p=asNum(coef22_pere.value), k2f=asNum(coef22_fils.value), k2c=asNum(coef22_petit.value);

  const validOrder=(ds&&da1&&da2&&de)?(new Date(ds)<=new Date(da1)&&new Date(da1)<=new Date(da2)&&new Date(da2)<=new Date(de)&& S<=A1 && A1<=A2 && A2<=E):false;
  const coefsOK2 = [k2p,k2f,k2c].every(x=>x>=0 && x<=1) && Math.abs((k2p+k2f+k2c)-1)<1e-6;

  let q1=NaN,q2=NaN,q3=NaN,p1=NaN,c1=NaN,p2=NaN,c2=NaN,g2=NaN,totP=NaN;
  let okSeg2=false, okSeg3=false, okDelta=false;
  const ready = ds&&da1&&da2&&de && [S,A1,A2,E].every(Number.isFinite) && Number.isFinite(k1) && coefsOK2 && validOrder;

  if(ready){
    q1=A1-S; q2=A2-A1; q3=E-A2;
    p1=Math.round(q2*k1); c1=q2-p1;
    p2=Math.round(q3*k2p); c2=Math.round(q3*k2f); g2=q3-p2-c2; // petit-fils absorbe l‚Äô√©cart d‚Äôarrondi
    totP=q1+p1+p2;

    okSeg2 = (p1 + c1 === q2);
    okSeg3 = (p2 + c2 + g2 === q3);
    okDelta = ((E - S) === (q1 + q2 + q3));
  }

  // Ligne de vie
  drawTimeline(timeline2,[
    {tag:"fstart", d:FS?new Date(FS):null},
    {tag:"fend",   d:FE?new Date(FE):null},
    {d:ds?new Date(ds):null,  idx:S},
    {d:da1?new Date(da1):null,idx:A1},
    {d:da2?new Date(da2):null,idx:A2},
    {d:de?new Date(de):null,  idx:E},
    {d:ds&&da1?new Date((+new Date(ds)+new Date(da1))/2):null,lbl:"S1 : 100 % p√®re"},
    {d:da1&&da2?new Date((+new Date(da1)+new Date(da2))/2):null,lbl:(Number.isFinite(k1)?`S2 : ${pctText(k1)} % p√®re`:"S2")},
    {d:da2&&de?new Date((+new Date(da2)+new Date(de))/2):null,lbl:(coefsOK2?`S3 : ${pctText(k2p)} % p√®re`:"S3")}
  ]);

  // Histogramme empil√© par segment
  drawStackedPF2(bars2, {q1,q2,q3,p1,c1,p2,c2,g2});

  // BAP (p√®re)
  if (ready){
    let line = [
      `BAP : AP1 au ${fmt(da1)} (index ${A1}) puis AP2 au ${fmt(da2)} (index ${A2})`,
      `; avant AP1 : ${A1} ‚àí ${S} = ${q1}`,
      `; entre AP1 et AP2 : ${A2} ‚àí ${A1} = ${q2} √ó ${pctText(k1)} % = ${p1}`,
      `; apr√®s AP2 : ${E} ‚àí ${A2} = ${q3} √ó ${pctText(k2p)} % = ${p2}`,
      `‚áí quantit√© attendue de la facture (p√®re) = ${q1} + ${p1} + ${p2}`
    ].join(" ");
    const pStr=(price2.value||"").trim(), pNum=asNum(pStr);
    bap2.value = (pStr && Number.isFinite(pNum))
      ? `${line} soit ${totP} √ó ${pStr} = ${(totP*pNum).toLocaleString("fr-FR",{minimumFractionDigits:2,maximumFractionDigits:2})}‚Ç¨`
      : line;
  } else {
    bap2.value = "";
  }

  renderChroniqueLive2({FS,FE,ds,S,da1,A1,da2,A2,de,E,k1,k2p,k2f,k2c,
                        q1,q2,q3,p1,c1,p2,c2,g2,totP,
                        validOrder, coefsOK2, okSeg2, okSeg3, okDelta, ready});
}

/* =================== Listeners & INIT =================== */
window.addEventListener('DOMContentLoaded', ()=>{
  // PF1
  [fStart1,fEnd1,dStart1,iStart1,dAP1,iAP1,dEnd1,iEnd1,coef1,price1].forEach(el=>el.addEventListener('input', compute1));
  document.getElementById('exA1').addEventListener('click', ()=>{
    fStart1.value="2024-03-05"; fEnd1.value="2025-03-05";
    dStart1.value="2024-03-05"; iStart1.value="12000";
    dAP1.value="2024-08-20";   iAP1.value="18450";
    dEnd1.value="2025-03-05";  iEnd1.value="25380";
    coef1.value="0.70";        price1.value="0.10";
    compute1();
  });
  document.getElementById('exB1').addEventListener('click', ()=>{
    fStart1.value="2019-10-24"; fEnd1.value="2020-10-23";
    dStart1.value="2019-10-24"; iStart1.value="0";
    dAP1.value="2020-05-27";   iAP1.value="1715";
    dEnd1.value="2020-10-23";  iEnd1.value="3112";
    coef1.value="0.80";        price1.value="";
    compute1();
  });
  document.getElementById('clear1').addEventListener('click', ()=>{
    [fStart1,fEnd1,dStart1,iStart1,dAP1,iAP1,dEnd1,iEnd1,coef1,price1].forEach(el=>el.value="");
    document.getElementById('chroniqueLive1').innerHTML=""; timeline1.innerHTML=""; bap1.value="";
  });
  document.getElementById('copy1').addEventListener('click', ()=>{ bap1.select(); document.execCommand('copy'); });

  // PF2
  [fStart2,fEnd2,dStart2,iStart2,dAP21,iAP21,dAP22,iAP22,dEnd2,iEnd2,
   coef21_pere,coef22_pere,coef22_fils,coef22_petit,price2
  ].forEach(el=>el.addEventListener('input', compute2));

  document.getElementById('ex2').addEventListener('click', ()=>{
    fStart2.value="2024-01-01";  fEnd2.value="2024-12-31";
    dStart2.value="2024-01-01";  iStart2.value="5000";
    dAP21.value="2024-04-01";    iAP21.value="6200";
    dAP22.value="2024-09-15";    iAP22.value="9100";
    dEnd2.value="2024-12-31";    iEnd2.value="11200";
    coef21_pere.value="0.70";    // S2 : 70% p√®re
    coef22_pere.value="0.60";    // S3 : 60/25/15
    coef22_fils.value="0.25";
    coef22_petit.value="0.15";
    price2.value="0.10";
    compute2();
  });

  document.getElementById('clear2').addEventListener('click', ()=>{
    [fStart2,fEnd2,dStart2,iStart2,dAP21,iAP21,dAP22,iAP22,dEnd2,iEnd2,
     coef21_pere,coef22_pere,coef22_fils,coef22_petit,price2
    ].forEach(el=>el.value="");
    chrono2.innerHTML=""; timeline2.innerHTML=""; bars2.innerHTML=""; bap2.value="";
  });

  // D√©marrage : on pr√©charge l‚Äôexemple PF1
  document.getElementById('exA1').click();
});
</script>
</body>
</html>
