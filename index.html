<!DOCTYPE html>
<html lang="fr" data-theme="light">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Calcul norm√© pour augmentation de puissance ‚Äî p√®re & fils</title>
<meta name="color-scheme" content="light dark" />
<style>
  :root{
    --bg:#f7f7fb; --panel:#fff; --text:#16161b; --muted:#6b7280;
    --accent:#4f46e5; --accent-weak:#eef2ff;
    --border:#e7e7ef; --shadow:0 10px 26px rgba(16,24,40,.06);
    --ok:#10b981; --ko:#ef4444;
  }
  html[data-theme="dark"]{
    --bg:#0f1115; --panel:#161a22; --text:#e9e9f2; --muted:#9aa0aa;
    --accent:#8b93ff; --accent-weak:#1e2330; --border:#262b36; --shadow:0 12px 28px rgba(0,0,0,.45);
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  .topbar{position:sticky;top:0;z-index:10;display:flex;align-items:center;justify-content:space-between;gap:12px;
    padding:14px 18px;background:var(--panel);border-bottom:1px solid var(--border);box-shadow:var(--shadow)}
  .topbar h1{font-size:18px;margin:0}
  .actions{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .btn{border-radius:10px;border:1px solid var(--border);background:var(--panel);color:var(--text);padding:10px 14px;cursor:pointer}
  .btn.primary{background:var(--accent);color:#fff;border-color:transparent}
  .btn.ghost{background:transparent}
  .control{background:transparent;border:1px solid var(--border);border-radius:10px;padding:10px 12px;color:var(--text);width:100%}
  .control:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px var(--accent-weak)}
  .container{max-width:1100px;margin:18px auto;padding:0 18px;display:grid;gap:18px}
  .panel{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:16px 16px 20px;box-shadow:var(--shadow)}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:14px}
  .row{display:grid;grid-template-columns:230px 1fr;gap:10px;align-items:center;margin:8px 0}
  .help{grid-column:2/3;font-size:12px;color:var(--muted);margin-top:-6px;margin-bottom:6px}
  .mono{font-variant-numeric:tabular-nums}
  .muted{color:var(--muted)}
  .note{font-size:13px;color:var(--muted)}
  .ok{color:var(--ok)} .ko{color:var(--ko)}
  textarea{width:100%;min-height:120px;resize:vertical;border-radius:10px;border:1px solid var(--border);padding:10px}
  svg.timeline{width:100%;height:210px}
  .small{font-size:13px}
</style>
</head>
<body>
<header class="topbar">
  <h1>Calcul norm√© pour augmentation de puissance ‚Äî p√®re & fils</h1>
  <div class="actions">
    <button id="exA" class="btn">Exemple (80%)</button>
    <button id="exB" class="btn">Exemple (70%)</button>
    <button id="clear" class="btn">Vider le formulaire</button>
    <button id="theme" class="btn ghost">üåô/‚òÄÔ∏è</button>
  </div>
</header>

<main class="container">
  <section class="panel">
    <h3>1) Renseigne le cas</h3>
    <div class="grid">
      <div>
        <h4>P√©riode de facturation (facture √† traiter)</h4>
        <div class="row"><label>D√©but de p√©riode</label><input id="fStart" type="date" class="control"></div>
        <div class="help">D√©but de la facture (ex. 01/07 pour S2).</div>
        <div class="row"><label>Fin de p√©riode</label><input id="fEnd" type="date" class="control"></div>
        <div class="help">Fin de la facture (ex. 31/12 pour S2).</div>

        <h4 style="margin-top:12px">Trois jalons d‚Äôindex</h4>
        <div class="row"><label>Fin de facture N-1</label><input id="dStart" type="date" class="control"></div>
        <div class="help">Date de fin de la facture pr√©c√©dente (avant AP).</div>

        <div class="row"><label>Index √† fin N-1 (p√®re)</label><input id="iStart" type="number" step="1" class="control" placeholder="ex. 0"></div>

        <div class="row"><label>Date d‚ÄôAP</label><input id="dAP" type="date" class="control"></div>
        <div class="help">Jour de l‚Äôaugmentation de puissance (mise en service B). Tol√©rance J¬±1.</div>

        <div class="row"><label>Index le jour d‚ÄôAP</label><input id="iAP" type="number" step="1" class="control" placeholder="ex. 1715"></div>

        <div class="row"><label>Date anniversaire (p√®re)</label><input id="dEnd" type="date" class="control"></div>
        <div class="help">Date anniversaire du contrat p√®re (fin de la 1 ≥·µâ facture apr√®s AP).</div>

        <div class="row"><label>Index √† l‚Äôanniversaire</label><input id="iEnd" type="number" step="1" class="control" placeholder="ex. 3112"></div>

        <div class="row">
          <label>Coef p√®re apr√®s AP</label>
          <div style="display:flex;gap:8px;align-items:center">
            <input id="coef" type="number" step="0.01" min="0" max="1" class="control" placeholder="0.80 = 80 %">
          </div>
        </div>
        <div class="help">Part de production affect√©e au p√®re <b>apr√®s AP</b>. <span id="coefHints" class="mono"></span></div>

        <div class="row"><label>Prix (‚Ç¨/kWh) <span class="muted">(optionnel)</span></label>
          <input id="price" type="text" class="control" placeholder="0.10">
        </div>
        <div class="note">La phrase ¬´ soit ‚Ä¶ ‚Ç¨ ¬ª s‚Äôajoute uniquement si le prix est renseign√©.</div>
      </div>

      <div>
        <h4>Quantit√©s calcul√©es</h4>
        <div class="mono">
          <div>Q<sub>avant</sub> = <span id="q1">‚Äî</span> kWh <span class="muted">‚Äî 100 % au p√®re (avant AP)</span></div>
          <div>Q<sub>apr√®s</sub> = <span id="q2">‚Äî</span> kWh</div>
          <div>Part <b>p√®re</b> apr√®s = <span id="afterFather">‚Äî</span> kWh ‚Ä¢ Part <b>fils</b> apr√®s = <span id="afterChild">‚Äî</span> kWh</div>
          <div><b>Total p√®re attendu</b> = <span id="fatherTotal">‚Äî</span> kWh</div>
          <div id="checks" class="small muted" style="margin-top:6px"></div>
        </div>
      </div>
    </div>

    <!-- Ligne de vie graphique -->
    <div id="timeline" style="margin-top:14px"></div>
  </section>

  <section class="panel">
    <h3>2) Chronique (explications pas √† pas)</h3>
    <div id="chronique" class="chronique"></div>
  </section>

  <section class="panel">
    <h3>3) BAP ‚Äî Commentaire norm√© (copier/coller)</h3>
    <textarea id="bap" class="mono" readonly></textarea>
    <div style="display:flex;gap:10px;margin-top:8px">
      <button id="copy" class="btn primary">Copier le BAP</button>
      <span class="muted small">Tol√©rance ¬± 1 kWh ‚Ä¢ Arrondi √† l‚Äôunit√© sur la part p√®re</span>
    </div>
  </section>
</main>

<script>
  // Th√®me
  (function(){
    const root=document.documentElement, key="ap-theme";
    const saved=localStorage.getItem(key); if(saved) root.setAttribute("data-theme", saved);
    document.getElementById("theme").onclick=()=>{
      const next=root.getAttribute("data-theme")==="dark"?"light":"dark";
      root.setAttribute("data-theme", next); localStorage.setItem(key,next);
    };
  })();

  // S√©lecteurs
  const fStart = document.getElementById('fStart'), fEnd = document.getElementById('fEnd');
  const dStart = document.getElementById('dStart'), iStart=document.getElementById('iStart');
  const dAP = document.getElementById('dAP'), iAP=document.getElementById('iAP');
  const dEnd = document.getElementById('dEnd'), iEnd=document.getElementById('iEnd');
  const coef=document.getElementById('coef'), price=document.getElementById('price');
  const coefHints=document.getElementById('coefHints');

  const q1El=document.getElementById('q1'), q2El=document.getElementById('q2');
  const afterFatherEl=document.getElementById('afterFather'), afterChildEl=document.getElementById('afterChild');
  const fatherTotalEl=document.getElementById('fatherTotal'), checks=document.getElementById('checks');
  const timelineHost=document.getElementById('timeline'), bap=document.getElementById('bap');
  const chronique=document.getElementById('chronique');

  // Utils
  const i18n = n => Number(n).toLocaleString("fr-FR");
  const raw  = n => String(n);
  const fmt  = s => s ? new Date(s+"T00:00:00").toLocaleDateString("fr-FR") : "";
  const asNum = v => (v===""||v==null)? NaN : Number(String(v).replace(",","."));
  const pctText = x => (x*100).toLocaleString("fr-FR",{maximumFractionDigits:2}).replace(/\u00a0/g," ");
  const diffDays=(a,b)=>Math.round((new Date(b)-new Date(a))/(1000*3600*24));
  function guessPeriodLabel(a,b){
    if(!(a&&b)) return "";
    const d=diffDays(a,b);
    if(d>=330) return "p√©riode annuelle";
    if(d>=170 && d<=200) return "p√©riode semestrielle";
    return `p√©riode de ${d} jours`;
  }

  // Coef p√®re/fils (hint dynamique)
  function updateCoefHint(){
    const k=asNum(coef.value);
    if(k>=0 && k<=1){
      const pere=pctText(k), fils=pctText(1-k);
      coefHints.textContent = `(p√®re = ${pere} % ‚Ä¢ fils = ${fils} %)`;
    }else{
      coefHints.textContent = "";
    }
  }

  // LIGNE DE VIE graphique
  function drawTimeline(){
    timelineHost.innerHTML="";
    const svgNS="http://www.w3.org/2000/svg";
    const svg=document.createElementNS(svgNS,"svg");
    svg.setAttribute("class","timeline");
    svg.setAttribute("viewBox","0 0 1100 210");
    svg.setAttribute("preserveAspectRatio","xMidYMid meet");
    timelineHost.appendChild(svg);

    const marks=[];
    function add(dateStr, label, idx){
      if(dateStr){
        const d=new Date(dateStr+"T00:00:00");
        if(!isNaN(d)) marks.push({d,label,idx});
      }
    }
    add(fStart.value,"D√©but p√©riode");
    add(fEnd.value,"Fin p√©riode");
    add(dStart.value,"Fin N-1",asNum(iStart.value));
    add(dAP.value,"AP",asNum(iAP.value));
    add(dEnd.value,"Anniversaire",asNum(iEnd.value));

    if(marks.length<2){
      const p=document.createElement("div");
      p.className="muted small"; p.textContent="Saisis la p√©riode et les jalons : la ligne de vie se dessine automatiquement.";
      timelineHost.appendChild(p); return;
    }

    marks.sort((a,b)=>a.d-b.d);
    const min=marks[0].d, max=marks[marks.length-1].d;
    const span=Math.max(1,(max-min));
    const X=d=>40+((d-min)/span)*1020;

    function node(tag,attrs){const n=document.createElementNS(svgNS,tag);for(const k in attrs)n.setAttribute(k,attrs[k]);svg.appendChild(n);return n;}
    function line(x1,y1,x2,y2,w,col){node("line",{x1,y1,x2,y2,stroke:col||"currentColor","stroke-width":w,"stroke-linecap":"round"});}
    function vmark(x){node("line",{x1:x,y1:70,x2:x,y2:110,stroke:"currentColor","stroke-width":3});}
    function text(t,x,y,anchor="start",size=14){const n=node("text",{x,y,"text-anchor":anchor,"font-size":size}); n.textContent=t;}

    if(fStart.value && fEnd.value){
      const x1=X(new Date(fStart.value+"T00:00:00")), x2=X(new Date(fEnd.value+"T00:00:00"));
      node("rect",{x:Math.min(x1,x2),y:78,width:Math.abs(x2-x1),height:24,fill:"var(--accent-weak)",opacity:"0.6"});
      text("P√©riode de facturation",(x1+x2)/2,66,"middle",12);
    }

    line(X(min),90,X(max),90,6,"#2a63e7");

    marks.forEach(m=>{
      const x=X(m.d); vmark(x);
      text(fmt(m.d.toISOString().slice(0,10)),x,36,"middle");
      if(Number.isFinite(m.idx)) text(raw(m.idx),x,140,"middle");
    });

    if(dStart.value && dAP.value){
      const xs=X(new Date(dStart.value+"T00:00:00")), xa=X(new Date(dAP.value+"T00:00:00"));
      text("100 % p√®re (avant AP)",(xs+xa)/2,168,"middle");
    }
    if(dAP.value && dEnd.value){
      const xa=X(new Date(dAP.value+"T00:00:00")), xe=X(new Date(dEnd.value+"T00:00:00"));
      const k=asNum(coef.value); if(Number.isFinite(k)) text(`${pctText(k)} % p√®re (apr√®s AP)`,(xa+xe)/2,168,"middle");
    }
  }

  // CHRONIQUE d√©taill√©e
  function renderChronique(values){
    const {
      FS, FE, ds, S, da, A, de, E, k,
      q1, q2, fatherAfter, childAfter, fatherTotal,
      validOrder, ok1, ok2
    } = values;

    const parts=[];
    if(FS && FE){
      parts.push(`<h4>Cadre de la facture</h4>`);
      parts.push(`<p>La facture que tu traites couvre la <span style="background:var(--accent-weak);padding:2px 8px;border-radius:999px"> ${guessPeriodLabel(FS,FE)} </span>, du <b>${fmt(FS)}</b> au <b>${fmt(FE)}</b>.</p>`);
    } else {
      parts.push(`<h4>Cadre de la facture</h4><p class="muted">Renseigne le d√©but et la fin : je reconna√Ætrai s‚Äôil s‚Äôagit d‚Äôune p√©riode semestrielle ou annuelle.</p>`);
    }

    parts.push(`<h4>Rep√®res d‚Äôindex</h4>`);
    if(ds){ parts.push(`<p>Point de d√©part (fin N-1) : <b>${fmt(ds)}</b>${Number.isFinite(S)?` ‚Äî index <b>${raw(S)}</b>`:""}.</p>`); }
    if(da){ parts.push(`<p>Augmentation de puissance le <b>${fmt(da)}</b>${Number.isFinite(A)?` ‚Äî index <b>${raw(A)}</b>`:""}. √Ä partir de ce jour, la production se ventile entre p√®re et fils.</p>`); }
    if(de){ parts.push(`<p>Arr√™t de la 1 ≥·µâ facture post-AP √† la date anniversaire : <b>${fmt(de)}</b>${Number.isFinite(E)?` ‚Äî index <b>${raw(E)}</b>`:""}.</p>`); }
    if(!ds && !da && !de){ parts.push(`<p class="muted">Renseigne les trois jalons : fin N-1 ‚Üí AP ‚Üí anniversaire.</p>`); }

    if(ds && da){
      parts.push(`<h4>D√©coupage de la production</h4>`);
      parts.push(`<p>Avant AP : du <b>${fmt(ds)}</b> au <b>${fmt(da)}</b> ‚Üí <b>100 %</b> au <b>p√®re</b>.</p>`);
      if(de){
        if(Number.isFinite(k)){
          const filsPct = pctText(1-k);
          parts.push(`<p>Apr√®s AP : du <b>${fmt(da)}</b> au <b>${fmt(de)}</b> ‚Üí <b>${pctText(k)} %</b> au p√®re et <b>${filsPct}</b> au fils.</p>`);
        } else {
          parts.push(`<p>Apr√®s AP : du <b>${fmt(da)}</b> au <b>${fmt(de)}</b> ‚Üí renseigne le <b>coef p√®re</b> pour ventiler.</p>`);
        }
      }
    }

    if(Number.isFinite(S) && Number.isFinite(A) && Number.isFinite(E) && (k>=0 && k<=1) && validOrder){
      parts.push(`<h4>Quantit√©s attendues</h4>`);
      parts.push(`<p>Avant AP : <b>${raw(A)} ‚àí ${raw(S)} = ${raw(q1)} kWh</b> (p√®re 100 %).<br>
      Apr√®s AP : <b>${raw(E)} ‚àí ${raw(A)} = ${raw(q2)} kWh</b> ‚Üí p√®re <b>${raw(fatherAfter)} kWh</b>, fils <b>${raw(childAfter)} kWh</b>.<br>
      Total p√®re attendu : <b>${raw(fatherTotal)} kWh</b>.</p>`);

      parts.push(`<h4>Auto-contr√¥les</h4>`);
      parts.push(`<p>${ok1?`‚úÖ`:`‚ùå`} p√®re apr√®s + fils apr√®s = Q_apr√®s ‚Ä¢ ${ok2?`‚úÖ`:`‚ùå`} Q_avant + Q_apr√®s = Œîindex.</p>`);
    }

    if(ds && da && de && (!validOrder || !Number.isFinite(S) || !Number.isFinite(A) || !Number.isFinite(E))){
      parts.push(`<h4>√Ä corriger</h4>`);
      if(!validOrder) parts.push(`<p>‚Ä¢ V√©rifie l‚Äôordre temporel : <b>fin N-1 ‚â§ AP ‚â§ anniversaire</b> et les <b>index croissants</b>.</p>`);
      if(!Number.isFinite(S)) parts.push(`<p>‚Ä¢ Saisir l‚Äôindex de <b>fin N-1</b>.</p>`);
      if(!Number.isFinite(A)) parts.push(`<p>‚Ä¢ Saisir l‚Äô<b>index le jour d‚ÄôAP</b> (tol√©rance J¬±1).</p>`);
      if(!Number.isFinite(E)) parts.push(`<p>‚Ä¢ Saisir l‚Äô<b>index √† l‚Äôanniversaire</b>.</p>`);
      if(!(k>=0 && k<=1)) parts.push(`<p>‚Ä¢ Saisir le <b>coef p√®re</b> (0 ‚Üí 1).</p>`);
    }
    chronique.innerHTML = parts.join("");
  }

  // CALCULS + BAP
  function compute(){
    updateCoefHint();
    drawTimeline();

    const FS=fStart.value, FE=fEnd.value;
    const ds=dStart.value, da=dAP.value, de=dEnd.value;
    const S=asNum(iStart.value), A=asNum(iAP.value), E=asNum(iEnd.value);
    const k=asNum(coef.value);

    const validOrder = (ds && da && de) ? (new Date(ds)<=new Date(da) && new Date(da)<=new Date(de) && S<=A && A<=E) : false;

    let q1=NaN,q2=NaN,fatherAfter=NaN,childAfter=NaN,fatherTotal=NaN, ok1=false, ok2=false;
    const ready = ds && da && de && Number.isFinite(S) && Number.isFinite(A) && Number.isFinite(E) && (k>=0 && k<=1) && validOrder;

    if(ready){
      q1=A-S; q2=E-A;
      fatherAfter=Math.round(q2*k);
      childAfter=q2-fatherAfter;
      fatherTotal=q1+fatherAfter;
      ok1=(fatherAfter+childAfter===q2);
      ok2=((E-S)===(q1+q2));

      q1El.textContent=i18n(q1);
      q2El.textContent=i18n(q2);
      afterFatherEl.textContent=i18n(fatherAfter);
      afterChildEl.textContent=i18n(childAfter);
      fatherTotalEl.textContent=i18n(fatherTotal);

      checks.innerHTML=`${ok1?"<span class='ok'>‚úÖ</span>":"<span class='ko'>‚ùå</span>"} p√®re apr√®s + fils apr√®s = Q_apr√®s ‚Ä¢ ${ok2?"<span class='ok'>‚úÖ</span>":"<span class='ko'>‚ùå</span>"} Q_avant + Q_apr√®s = Œîindex`;
    }else{
      q1El.textContent=q2El.textContent=afterFatherEl.textContent=afterChildEl.textContent=fatherTotalEl.textContent="‚Äî";
      checks.textContent="Compl√®te la p√©riode, les 3 jalons (dates + index) et le coef p√®re pour calculer.";
    }

    // BAP norm√©
    const coefPct=pctText(k);
    if(ready){
      let line = `BAP : augmentation de puissance au ${fmt(da)} avec un index de ${raw(A)} ` +
                 `soit avant augmentation de puissance : ${raw(A)} - ${raw(S)} = ${raw(q1)} ` +
                 `+ apr√®s augmentation de puissance : ${raw(E)} - ${raw(A)} = ${raw(q2)} x ${coefPct} % = ${raw(fatherAfter)} ` +
                 `=> quantit√© attendue de la facture = ${raw(q1)} + ${raw(fatherAfter)}`;
      const pStr=(price.value||"").trim(), pNum=asNum(pStr);
      if(pStr && Number.isFinite(pNum)){
        const amount=(fatherTotal*pNum).toLocaleString("fr-FR",{minimumFractionDigits:2,maximumFractionDigits:2});
        line += ` soit ${raw(fatherTotal)} x ${pStr} = ${amount}‚Ç¨`;
      }
      bap.value=line;
    }else{
      bap.value="";
    }

    // Chronique
    const pack={FS,FE,ds,S,da,A,de,E,k,q1,q2,fatherAfter,childAfter,fatherTotal,validOrder,ok1,ok2};
    renderChronique(pack);
  }

  // √âcouteurs
  [fStart,fEnd,dStart,iStart,dAP,iAP,dEnd,iEnd,coef,price].forEach(el=>el.addEventListener('input', compute));

  // Exemples
  document.getElementById('exA').onclick=()=>{
    fStart.value="2024-03-05"; fEnd.value="2025-03-05";
    dStart.value="2024-03-05"; iStart.value="12000";
    dAP.value="2024-08-20";    iAP.value="18450";
    dEnd.value="2025-03-05";   iEnd.value="25380";
    coef.value="0.70"; price.value="0.10"; compute();
  };
  document.getElementById('exB').onclick=()=>{
    fStart.value="2019-10-24"; fEnd.value="2020-10-23";
    dStart.value="2019-10-24"; iStart.value="0";
    dAP.value="2020-05-27";    iAP.value="1715";
    dEnd.value="2020-10-23";   iEnd.value="3112";
    coef.value="0.80"; price.value=""; compute();
  };

  // Vider
  document.getElementById('clear').onclick=()=>{
    [fStart,fEnd,dStart,iStart,dAP,iAP,dEnd,iEnd,coef,price].forEach(el=>el.value="");
    coefHints.textContent="";
    q1El.textContent=q2El.textContent=afterFatherEl.textContent=afterChildEl.textContent=fatherTotalEl.textContent="‚Äî";
    checks.textContent="Saisis la p√©riode, les 3 jalons et le coef p√®re : le calcul et le BAP apparaissent.";
    bap.value=""; drawTimeline(); chronique.innerHTML="";
  };

  // Copier BAP
  document.getElementById('copy').onclick=()=>{
    bap.select(); document.execCommand('copy');
    const btn=document.getElementById('copy'); btn.textContent="Copi√© ‚úì"; setTimeout(()=>btn.textContent="Copier le BAP",900);
  };

  // Init
  document.getElementById('exA').click();
</script>
</body>
</html>
