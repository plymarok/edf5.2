<!DOCTYPE html>
<html lang="fr" data-theme="light">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Calcul norm√© ‚Äî AP P√®re & Fils / P√®re, Fils & Petit-fils</title>
<meta name="color-scheme" content="light dark" />
<style>
  :root{
    --bg:#f7f7fb; --panel:#fff; --text:#16161b; --muted:#6b7280;
    --accent:#4f46e5; --accent-weak:#eef2ff;
    --border:#e7e7ef; --shadow:0 10px 26px rgba(16,24,40,.06);
    --col-pere:#4f46e5; --col-fils:#10b981; --col-petit:#a855f7;
  }
  html[data-theme="dark"]{
    --bg:#0f1115; --panel:#161a22; --text:#e9e9f2; --muted:#9aa0aa;
    --accent:#8b93ff; --accent-weak:#1e2330; --border:#262b36; --shadow:0 12px 28px rgba(0,0,0,.45);
    --col-pere:#8b93ff; --col-fils:#34d399; --col-petit:#c084fc;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:17px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  .topbar{position:sticky;top:0;z-index:10;display:flex;align-items:center;justify-content:space-between;gap:12px;
    padding:16px 22px;background:var(--panel);border-bottom:1px solid var(--border);box-shadow:var(--shadow)}
  .topbar h1{font-size:19px;margin:0}
  .btn{border-radius:12px;border:1px solid var(--border);background:var(--panel);color:var(--text);padding:11px 16px;cursor:pointer;font-size:15px}
  .btn.primary{background:var(--accent);color:#fff;border-color:transparent}
  .btn.ghost{background:transparent}
  .btn.small{padding:7px 12px;font-size:14px;border-radius:10px}
  .btn.active{background:var(--accent);color:#fff;border-color:transparent}

  .tabs{display:flex;gap:10px;margin:18px auto;max-width:1700px;padding:0 22px}
  .tab{padding:11px 16px;border:1px solid var(--border);border-radius:12px;background:var(--panel);cursor:pointer;font-size:15px}
  .tab.active{background:var(--accent);color:#fff;border-color:transparent}

  /* === Zones √©largies === */
  .container{max-width:1700px;margin:0 auto 28px;padding:0 22px}
  .duo{display:grid;grid-template-columns:minmax(420px,1fr) minmax(820px,1.6fr);gap:22px}

  .panel{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:18px 18px 22px;box-shadow:var(--shadow)}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(420px,1fr));gap:18px}

  /* === Labels/champs : largeur mini pour √©viter le tronquage === */
  .row{
    display:grid;
    grid-template-columns: 260px minmax(300px,1fr); /* <‚Äî label 260px, champ min 300px */
    gap:12px; align-items:center; margin:10px 0;
  }
  .help{grid-column:1/-1;margin:-2px 0 8px 260px;font-size:13px;color:var(--muted)}
  .section{margin-top:16px}
  .control{
    background:transparent;border:1px solid var(--border);border-radius:12px;
    padding:12px 14px;color:var(--text);width:100%;min-width:0;font-size:17px;
    font-variant-numeric:tabular-nums; /* chiffres bien droits, lisibles */
  }
  .control::placeholder{opacity:.7}

  .control:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px var(--accent-weak)}
  .muted{color:var(--muted)} .mono{font-variant-numeric:tabular-nums}
  textarea{width:100%;min-height:130px;resize:vertical;border-radius:12px;border:1px solid var(--border);padding:12px;font-size:15px}
  .chroniqueLive{min-height:220px;border:1px solid var(--border);border-radius:14px;padding:16px;background:var(--panel);font-size:16px}
  .chroniqueLive h4{margin:6px 0 10px;font-size:18px} .chroniqueLive p{margin:7px 0}
  .chip{display:inline-block;background:var(--accent-weak);padding:3px 10px;border-radius:999px}

  /* Timelines & bars plus grands */
  svg.timeline{width:100%;height:300px}
  .legend{display:flex;gap:16px;align-items:center;font-size:15px;color:var(--muted);margin-top:10px}
  .swatch{width:14px;height:14px;border-radius:3px;display:inline-block}
  .sw-pere{background:var(--col-pere)} .sw-fils{background:var(--col-fils)} .sw-petit{background:var(--col-petit)}

  .tab-panel{display:none}
  .tab-panel.active{display:block}

  .example .control{background:rgba(127,127,127,.06)}
  .example .control[disabled]{opacity:.85;cursor:not-allowed}
  .ghost-note{font-size:13px;color:var(--muted);margin:8px 0 0}

  .view-toggle{display:flex;gap:10px;margin:12px 0}
  .view{display:none}
  .view.active{display:block}
</style>
</head>
<body>
<header class="topbar">
  <h1>Calcul norm√© ‚Äî Augmentations de puissance (p√®re, fils, petit-fils)</h1>
  <div class="actions">
    <button id="theme" class="btn ghost" type="button">üåô/‚òÄÔ∏è</button>
  </div>
</header>

<nav class="tabs">
  <button class="tab active" data-panel="pf1" type="button">P√®re & Fils ‚Äî 1 AP</button>
  <button class="tab" data-panel="pf2" type="button">P√®re, Fils & Petit-fils ‚Äî 2 AP</button>
</nav>

<!-- =================== ONGLET 1 : P√àRE & FILS (1 AP) =================== -->
<main id="pf1" class="container tab-panel active">
  <div class="duo">
    <!-- EXEMPLE NON INTERACTIF -->
    <section class="panel example">
      <h3>Mod√®le d‚Äôexemple</h3>
      <div class="grid">
        <div>
          <h4>P√©riode de facturation</h4>
          <div class="row"><label>D√©but de p√©riode</label><input id="fStart1X" class="control" type="date" disabled></div>
          <div class="row"><label>Fin de p√©riode</label><input id="fEnd1X" class="control" type="date" disabled></div>

          <h4 class="section">Rep√®res d‚Äôindex (p√®re)</h4>
          <div class="row"><label>Fin de facture pr√©c√©dente (N-1)</label><input id="dStart1X" class="control" type="date" disabled></div>
          <div class="row"><label>Index au N-1</label><input id="iStart1X" class="control" type="number" disabled></div>
          <div class="row"><label>Date d‚ÄôAP</label><input id="dAP1X" class="control" type="date" disabled></div>
          <div class="row"><label>Index √† l‚ÄôAP</label><input id="iAP1X" class="control" type="number" disabled></div>
          <div class="row"><label>Date anniversaire</label><input id="dEnd1XX" class="control" type="date" disabled></div>
          <div class="row"><label>Index √† l‚Äôanniversaire</label><input id="iEnd1X" class="control" type="number" disabled></div>

          <h4 class="section">R√©partition apr√®s AP</h4>
          <div class="row"><label>Part du p√®re (apr√®s AP)</label><input id="coef1X" class="control" type="number" disabled></div>
          <p class="ghost-note">Exemple verrouill√© ‚Äî sert de rep√®re visuel.</p>
        </div>

        <div>
          <h4>Chronique (exemple)</h4>
          <div id="chroniqueLive1X" class="chroniqueLive"></div>
        </div>
      </div>
      <div id="timeline1X" style="margin-top:16px"></div>
      <div id="bars1X" style="margin-top:16px"></div>
    </section>

    <!-- CALCULATEUR INTERACTIF -->
    <section class="panel">
      <h3>Mod√®le de calcul</h3>
      <div class="grid">
        <div>
          <h4>P√©riode de facturation</h4>
          <div class="row"><label>D√©but de p√©riode</label><input id="fStart1" class="control" type="date"></div>
          <div class="row"><label>Fin de p√©riode</label><input id="fEnd1" class="control" type="date"></div>

          <h4 class="section">Rep√®res d‚Äôindex (p√®re)</h4>
          <div class="row"><label>Fin de facture pr√©c√©dente (N-1)</label><input id="dStart1" class="control" type="date"></div>
          <div class="row"><label>Index au N-1</label><input id="iStart1" class="control" type="number" step="1" inputmode="decimal" placeholder="ex. 12000"></div>
          <div class="row"><label>Date d‚ÄôAP</label><input id="dAP1" class="control" type="date"></div>
          <div class="row"><label>Index √† l‚ÄôAP</label><input id="iAP1" class="control" type="number" step="1" inputmode="decimal" placeholder="ex. 18450"></div>
          <div class="row"><label>Date anniversaire</label><input id="dEnd1" class="control" type="date"></div>
          <div class="row"><label>Index √† l‚Äôanniversaire</label><input id="iEnd1" class="control" type="number" step="1" inputmode="decimal" placeholder="ex. 25380"></div>

          <h4 class="section">R√©partition apr√®s AP</h4>
          <div class="row"><label>Part du p√®re (apr√®s AP)</label><input id="coef1" class="control" type="number" step="0.01" min="0" max="1" inputmode="decimal" placeholder="ex. 0,70 = 70 %"></div>

          <div class="row"><label>Prix (‚Ç¨/kWh) <span class="muted">(facultatif)</span></label><input id="price1" class="control" type="text" inputmode="decimal" placeholder="ex. 0,10"></div>

          <div style="display:flex;gap:10px;margin-top:12px">
            <button id="exA1" class="btn" type="button">Exemple (70 %)</button>
            <button id="exB1" class="btn" type="button">Exemple (80 %)</button>
            <button id="clear1" class="btn" type="button">Vider</button>
          </div>
        </div>

        <div>
          <h4>Chronique (calcul)</h4>
          <div id="chroniqueLive1" class="chroniqueLive"></div>
        </div>
      </div>

      <div class="view-toggle">
        <button id="v1time" class="btn small active" type="button">Ligne de vie</button>
        <button id="v1bars" class="btn small" type="button">Histogramme par segment</button>
      </div>

      <div id="view1-time" class="view active">
        <div id="timeline1"></div>
      </div>
      <div id="view1-bars" class="view">
        <div id="bars1"></div>
      </div>

      <div class="panel" style="margin-top:16px;border-color:var(--border)">
        <h4>2) BAP ‚Äî Commentaire norm√©</h4>
        <textarea id="bap1" class="mono" readonly></textarea>
        <div style="display:flex;gap:12px;margin-top:10px">
          <button id="copy1" class="btn primary" type="button">Copier le BAP</button>
          <span class="muted">Tol√©rance ¬± 1 kWh ‚Ä¢ Arrondi sur la part p√®re</span>
        </div>
      </div>
    </section>
  </div>
</main>

<!-- =================== ONGLET 2 : P√àRE, FILS & PETIT-FILS (2 AP) =================== -->
<main id="pf2" class="container tab-panel">
  <div class="duo">
    <!-- EXEMPLE NON INTERACTIF -->
    <section class="panel example">
      <h3>Mod√®le d‚Äôexemple</h3>
      <div class="grid">
        <div>
          <h4>P√©riode de facturation</h4>
          <div class="row"><label>D√©but de p√©riode</label><input id="fStart2X" class="control" type="date" disabled></div>
          <div class="row"><label>Fin de p√©riode</label><input id="fEnd2X" class="control" type="date" disabled></div>

          <h4 class="section">Rep√®res d‚Äôindex (p√®re)</h4>
          <div class="row"><label>Fin de facture pr√©c√©dente (N-1)</label><input id="dStart2X" class="control" type="date" disabled></div>
          <div class="row"><label>Index au N-1</label><input id="iStart2X" class="control" type="number" disabled></div>

          <div class="row"><label>AP1 ‚Äî Date d‚Äôentr√©e du fils</label><input id="dAP21X" class="control" type="date" disabled></div>
          <div class="row"><label>Index √† l‚ÄôAP1</label><input id="iAP21X" class="control" type="number" disabled></div>

          <div class="row"><label>AP2 ‚Äî Date d‚Äôentr√©e petit-fils</label><input id="dAP22X" class="control" type="date" disabled></div>
          <div class="row"><label>Index √† l‚ÄôAP2</label><input id="iAP22X" class="control" type="number" disabled></div>

          <div class="row"><label>Date anniversaire</label><input id="dEnd2XX" class="control" type="date" disabled></div>
          <div class="row"><label>Index √† l‚Äôanniversaire</label><input id="iEnd2X" class="control" type="number" disabled></div>

          <h4 class="section">R√©partition</h4>
          <div class="row"><label>Entre AP1 et AP2 ‚Äî part p√®re</label><input id="coef21_pereX" class="control" type="number" disabled></div>
          <div class="row"><label>Apr√®s AP2 ‚Äî part p√®re</label><input id="coef22_pereX" class="control" type="number" disabled></div>
          <div class="row"><label>Apr√®s AP2 ‚Äî part fils</label><input id="coef22_filsX" class="control" type="number" disabled></div>
          <div class="row"><label>Apr√®s AP2 ‚Äî part petit-fils</label><input id="coef22_petitX" class="control" type="number" disabled></div>

          <p class="ghost-note">Exemple verrouill√© ‚Äî lecture seule.</p>
        </div>

        <div>
          <h4>Chronique (exemple)</h4>
          <div id="chroniqueLive2X" class="chroniqueLive"></div>
        </div>
      </div>

      <div id="timeline2X" style="margin-top:16px"></div>
      <div id="bars2X" style="margin-top:16px"></div>
      <div class="legend">
        <span class="swatch sw-pere"></span> p√®re
        <span class="swatch sw-fils"></span> fils
        <span class="swatch sw-petit"></span> petit-fils
      </div>
    </section>

    <!-- CALCULATEUR INTERACTIF -->
    <section class="panel">
      <h3>Mod√®le de calcul</h3>
      <div class="grid">
        <div>
          <h4>P√©riode de facturation</h4>
          <div class="row"><label>D√©but de p√©riode</label><input id="fStart2" class="control" type="date"></div>
          <div class="row"><label>Fin de p√©riode</label><input id="fEnd2" class="control" type="date"></div>

          <h4 class="section">Rep√®res d‚Äôindex (p√®re)</h4>
          <div class="row"><label>Fin de facture pr√©c√©dente (N-1)</label><input id="dStart2" class="control" type="date"></div>
          <div class="row"><label>Index au N-1</label><input id="iStart2" class="control" type="number" step="1" inputmode="decimal" placeholder="ex. 5000"></div>

          <div class="row"><label>AP1 ‚Äî Date d‚Äôentr√©e du fils</label><input id="dAP21" class="control" type="date"></div>
          <div class="row"><label>Index √† l‚ÄôAP1</label><input id="iAP21" class="control" type="number" step="1" inputmode="decimal" placeholder="ex. 6200"></div>

          <div class="row"><label>AP2 ‚Äî Date d‚Äôentr√©e petit-fils</label><input id="dAP22" class="control" type="date"></div>
          <div class="row"><label>Index √† l‚ÄôAP2</label><input id="iAP22" class="control" type="number" step="1" inputmode="decimal" placeholder="ex. 9100"></div>

          <div class="row"><label>Date anniversaire</label><input id="dEnd2" class="control" type="date"></div>
          <div class="row"><label>Index √† l‚Äôanniversaire</label><input id="iEnd2" class="control" type="number" step="1" inputmode="decimal" placeholder="ex. 11200"></div>

          <h4 class="section">R√©partition</h4>
          <div class="row"><label>Entre AP1 et AP2 ‚Äî part p√®re</label><input id="coef21_pere" class="control" type="number" step="0.01" min="0" max="1" inputmode="decimal" placeholder="ex. 0,70"></div>
          <div class="row"><label>Apr√®s AP2 ‚Äî part p√®re</label><input id="coef22_pere" class="control" type="number" step="0.01" min="0" max="1" inputmode="decimal" placeholder="ex. 0,60"></div>
          <div class="row"><label>Apr√®s AP2 ‚Äî part fils</label><input id="coef22_fils" class="control" type="number" step="0.01" min="0" max="1" inputmode="decimal" placeholder="ex. 0,25"></div>
          <div class="row"><label>Apr√®s AP2 ‚Äî part petit-fils</label><input id="coef22_petit" class="control" type="number" step="0.01" min="0" max="1" inputmode="decimal" placeholder="ex. 0,15"></div>

          <div class="row"><label>Prix (‚Ç¨/kWh) <span class="muted">(facultatif)</span></label><input id="price2" class="control" type="text" inputmode="decimal" placeholder="ex. 0,10"></div>

          <div style="display:flex;gap:10px;margin-top:12px">
            <button id="ex2" class="btn" type="button">Charger un exemple</button>
            <button id="clear2" class="btn" type="button">Vider</button>
          </div>
        </div>

        <div>
          <h4>Chronique (calcul)</h4>
          <div id="chroniqueLive2" class="chroniqueLive"></div>
        </div>
      </div>

      <div class="view-toggle">
        <button id="v2time" class="btn small active" type="button">Ligne de vie</button>
        <button id="v2bars" class="btn small" type="button">Histogramme par segment</button>
      </div>

      <div id="view2-time" class="view active">
        <div id="timeline2"></div>
      </div>
      <div id="view2-bars" class="view">
        <div id="timeline2bars"></div>
      </div>

      <div class="legend">
        <span class="swatch sw-pere"></span> p√®re
        <span class="swatch sw-fils"></span> fils
        <span class="swatch sw-petit"></span> petit-fils
      </div>

      <div class="panel" style="margin-top:16px;border-color:var(--border)">
        <h4>2) BAP ‚Äî Commentaire norm√©</h4>
        <textarea id="bap2" class="mono" readonly></textarea>
        <div style="display:flex;gap:12px;margin-top:10px">
          <button id="copy2" class="btn primary" type="button">Copier le BAP</button>
          <span class="muted">Apr√®s AP2, les 3 parts doivent faire 100 %</span>
        </div>
      </div>
    </section>
  </div>
</main>

<script>
/* Th√®me */
(function(){const r=document.documentElement,k="ap-theme";const s=localStorage.getItem(k);if(s)r.setAttribute("data-theme",s);document.getElementById("theme").onclick=()=>{const n=r.getAttribute("data-theme")==="dark"?"light":"dark";r.setAttribute("data-theme",n);localStorage.setItem(k,n);};})();

/* Tabs */
document.querySelectorAll('.tabs .tab').forEach(b=>b.addEventListener('click',()=>{
  document.querySelectorAll('.tabs .tab').forEach(x=>x.classList.remove('active'));
  b.classList.add('active'); document.querySelectorAll('.tab-panel').forEach(p=>p.classList.remove('active'));
  document.getElementById(b.dataset.panel).classList.add('active');
}));

/* Helpers */
const raw=n=>String(n);
const fmtDate=s=>s?new Date(s+"T00:00:00").toLocaleDateString("fr-FR"):"";
const asNum=v=>(v===""||v==null)?NaN:Number(String(v).replace(",","."));
const pctText=x=>(x*100).toLocaleString("fr-FR",{maximumFractionDigits:2}).replace(/\u00a0/g," ");
const diffDays=(a,b)=>Math.round((new Date(b)-new Date(a))/(1000*3600*24));
function guessPeriodLabel(a,b){if(!(a&&b))return"";const d=diffDays(a,b);if(d>=330)return"p√©riode annuelle";if(d>=170&&d<=200)return"p√©riode semestrielle";return`p√©riode de ${d} jours`;}

/* Timeline SVG */
function drawTimeline(host,marks){
  host.innerHTML="";
  const NS="http://www.w3.org/2000/svg",svg=document.createElementNS(NS,"svg");
  svg.setAttribute("class","timeline");svg.setAttribute("viewBox","0 0 1200 300");svg.setAttribute("preserveAspectRatio","xMidYMid meet");host.appendChild(svg);
  const v=marks.filter(m=>m.d instanceof Date&&!isNaN(m.d));if(v.length<2){const p=document.createElement("div");p.className="muted";p.style.fontSize="16px";p.textContent="Renseigne la p√©riode et les jalons : la ligne de vie se dessine.";host.appendChild(p);return;}
  v.sort((a,b)=>a.d-b.d);const min=v[0].d.getTime(),max=v[v.length-1].d.getTime(),span=Math.max(1,max-min);const X=t=>60+((t-min)/span)*1060;
  function N(tag,attrs){const n=document.createElementNS(NS,tag);for(const k in attrs)n.setAttribute(k,attrs[k]);svg.appendChild(n);return n;}
  function vm(x){N("line",{x1:x,y1:118,x2:x,y2:162,stroke:"currentColor","stroke-width":4});}
  function label(t,x,y,a="start",s=16,w="normal"){const n=N("text",{x,y,"text-anchor":a,"font-size":s,"font-weight":w});n.textContent=t;}
  const fstart=marks.find(m=>m.tag==="fstart"),fend=marks.find(m=>m.tag==="fend");
  if(fstart?.d&&fend?.d){const x1=X(fstart.d.getTime()),x2=X(fend.d.getTime());N("rect",{x:Math.min(x1,x2),y:126,width:Math.abs(x2-x1),height:28,fill:"var(--accent-weak)",opacity:"0.6"});label("P√©riode de facturation",(x1+x2)/2,104,"middle",15,"600");}
  N("line",{x1:X(v[0].d.getTime()),y1:140,x2:X(v[v.length-1].d.getTime()),y2:140,stroke:"#2a63e7","stroke-width":8,"stroke-linecap":"round"});
  v.forEach(m=>{const x=X(m.d.getTime());vm(x);label(m.d.toLocaleDateString("fr-FR"),x,78,"middle",15,"600");if(Number.isFinite(m.idx))label(raw(m.idx),x,192,"middle",15);if(m.lbl)label(m.lbl,x,218,"middle",14);});
}

/* Histogrammes */
function drawStackedPF2(host,d){const{q1,q2,q3,p1,c1,p2,c2,g2,ds,da1,da2,de}=d;host.innerHTML="";const NS="http://www.w3.org/2000/svg",svg=document.createElementNS(NS,"svg");svg.setAttribute("viewBox","0 0 1200 360");svg.setAttribute("preserveAspectRatio","xMidYMid meet");host.appendChild(svg);
  function N(t,a){const n=document.createElementNS(NS,t);for(const k in a)n.setAttribute(k,a[k]);svg.appendChild(n);return n;}
  function L(t,x,y,a="start",s=16){const n=N("text",{x,y,"text-anchor":a,"font-size":s,fill:"currentColor"});n.textContent=t;}
  function S(n){return Number.isFinite(n)?n:0}
  function row(y,segs,title,qty,cap){const left=180,right=1120,w=right-left,h=34,r=7;const sum=segs.reduce((s,s1)=>s+S(s1.w),0)||1;let x=left;L(title,left-14,y+22,"end",16);L(`${S(qty)} kWh`,right+14,y+22,"start",16);segs.forEach(s=>{const ww=w*(S(s.w)/sum);if(ww<=0)return;N("rect",{x,y,width:ww,height:h,rx:r,ry:r,fill:s.color,opacity:"0.92"});if(ww>70)L(s.text,x+10,y+22,"start",15);x+=ww+1.5;});L(cap,left,y+52,"start",15);}
  L("Histogramme par segment (ventilation des kWh)",180,30,"start",17);
  const cap1=`S1 (avant AP1) : du ${fmtDate(ds)} au ${fmtDate(da1)} ‚Üí ${S(q1)} kWh, 100 % p√®re.`;
  const cap2=`S2 (AP1 ‚Üí AP2) : du ${fmtDate(da1)} au ${fmtDate(da2)} ‚Üí ${S(q2)} kWh dont ${S(p1)} p√®re & ${S(c1)} fils.`;
  const cap3=`S3 (apr√®s AP2) : du ${fmtDate(da2)} au ${fmtDate(de)} ‚Üí ${S(q3)} kWh dont ${S(p2)} p√®re, ${S(c2)} fils, ${S(g2)} petit-fils.`;
  row(70,[{w:q1,color:"var(--col-pere)",text:`p√®re ${S(q1)}`}],"S1 (avant AP1)",q1,cap1);
  row(150,[{w:p1,color:"var(--col-pere)",text:`p√®re ${S(p1)}`},{w:c1,color:"var(--col-fils)",text:`fils ${S(c1)}`}],"S2 (AP1 ‚Üí AP2)",q2,cap2);
  row(230,[{w:p2,color:"var(--col-pere)",text:`p√®re ${S(p2)}`},{w:c2,color:"var(--col-fils)",text:`fils ${S(c2)}`},{w:g2,color:"var(--col-petit)",text:`petit-fils ${S(g2)}`}],"S3 (apr√®s AP2)",q3,cap3);
  const tot=S(q1)+S(q2)+S(q3);L(`Total p√©riode : ${tot} kWh`,180,320,"start",16);
}
function drawStackedPF1(host,d){const{q1,q2,p2,c2,ds,da,de}=d;host.innerHTML="";const NS="http://www.w3.org/2000/svg",svg=document.createElementNS(NS,"svg");svg.setAttribute("viewBox","0 0 1200 300");svg.setAttribute("preserveAspectRatio","xMidYMid meet");host.appendChild(svg);
  function N(t,a){const n=document.createElementNS(NS,t);for(const k in a)n.setAttribute(k,a[k]);svg.appendChild(n);return n;}
  function L(t,x,y,a="start",s=16){const n=document.createElementNS(NS,"text");n.setAttribute("x",x);n.setAttribute("y",y);n.setAttribute("text-anchor",a);n.setAttribute("font-size",s);n.setAttribute("fill","currentColor");n.textContent=t;svg.appendChild(n);}
  function S(n){return Number.isFinite(n)?n:0}
  function row(y,segs,title,qty,cap){const left=180,right=1120,w=right-left,h=34,r=7;const sum=segs.reduce((s,s1)=>s+S(s1.w),0)||1;let x=left;L(title,left-14,y+22,"end",16);L(`${S(qty)} kWh`,right+14,y+22,"start",16);segs.forEach(s=>{const ww=w*(S(s.w)/sum);if(ww<=0)return;N("rect",{x,y,width:ww,height:h,rx:r,ry:r,fill:s.color,opacity:"0.92"});if(ww>70)L(s.text,x+10,y+22,"start",15);x+=ww+1.5;});L(cap,left,y+52,"start",15);}
  L("Histogramme par segment (ventilation des kWh)",180,30,"start",17);
  const cap1=`S1 (avant AP) : du ${fmtDate(ds)} au ${fmtDate(da)} ‚Üí ${S(q1)} kWh, 100 % p√®re.`;
  const cap2=`S2 (apr√®s AP) : du ${fmtDate(da)} au ${fmtDate(de)} ‚Üí ${S(q2)} kWh dont ${S(p2)} p√®re & ${S(c2)} fils.`;
  row(80,[{w:q1,color:"var(--col-pere)",text:`p√®re ${S(q1)}`}],"S1 (avant AP)",q1,cap1);
  row(165,[{w:p2,color:"var(--col-pere)",text:`p√®re ${S(p2)}`},{w:c2,color:"var(--col-fils)",text:`fils ${S(c2)}`}],"S2 (apr√®s AP)",q2,cap2);
  const tot=S(q1)+S(q2);L(`Total p√©riode : ${tot} kWh`,180,260,"start",16);
}

/* ===== PF1 (calcul) ===== */
const fStart1=document.getElementById('fStart1'), fEnd1=document.getElementById('fEnd1');
const dStart11=document.getElementById('dStart1'), iStart1=document.getElementById('iStart1');
const dAP1=document.getElementById('dAP1'), iAP1=document.getElementById('iAP1');
const dEnd1=document.getElementById('dEnd1'), iEnd1=document.getElementById('iEnd1');
const coef1=document.getElementById('coef1'), price1=document.getElementById('price1');
const v1timeBtn=document.getElementById('v1time'), v1barsBtn=document.getElementById('v1bars');
const timeline1=document.getElementById('timeline1'), bars1=document.getElementById('bars1'), bap1=document.getElementById('bap1');
let chroniqueLive=document.getElementById('chroniqueLive1'); let view1="time";

function renderChroniqueLive(v){
  const{FS,FE,ds,S,da,A,de,E,k,q1,q2,fatherAfter,childAfter,fatherTotal,validOrder,ok1,ok2,ready}=v;
  const L=[];
  if(FS&&FE){L.push(`<h4>Le cadre</h4><p>Tu traites une <span class="chip">${guessPeriodLabel(FS,FE)}</span> : du <b>${fmtDate(FS)}</b> au <b>${fmtDate(FE)}</b>. La production est d‚Äôabord 100 % p√®re, puis ventil√©e apr√®s l‚ÄôAP.</p>`);} else {L.push(`<h4>Le cadre</h4><p class="muted">Indique le d√©but et la fin de la facture ; on posera ensuite les rep√®res.</p>`);}
  const J=[]; if(ds)J.push(`N-1 ${fmtDate(ds)} : <b>${Number.isFinite(S)?S:"?"}</b>`); if(da)J.push(`AP ${fmtDate(da)} : <b>${Number.isFinite(A)?A:"?"}</b>`); if(de)J.push(`Anniv. ${fmtDate(de)} : <b>${Number.isFinite(E)?E:"?"}</b>`);
  L.push(J.length?`<p>Rep√®res : ${J.join(" ‚Ä¢ ")}.</p>`:`<p class="muted">Rep√®res attendus : N-1 ‚Üí AP ‚Üí Anniversaire.</p>`);
  if(da&&de){if(k>=0&&k<=1)L.push(`<p>Apr√®s l‚ÄôAP, la ventilation est de <b>${pctText(k)} %</b> au p√®re et <b>${pctText(1-k)} %</b> au fils.</p>`); else L.push(`<p class="muted">Saisis la part du p√®re apr√®s AP (entre 0 et 1). Avant AP : 100 % p√®re.</p>`);}
  if(ready){L.push(`<h4>Calcul clair</h4><p>Avant AP : <b>${A} ‚àí ${S} = ${q1} kWh</b> (100 % p√®re).</p><p>Apr√®s AP : <b>${E} ‚àí ${A} = ${q2} kWh</b> ‚Üí p√®re <b>${fatherAfter}</b> ‚Ä¢ fils <b>${childAfter}</b>.</p><p><b>Part p√®re attendue :</b> <b>${fatherTotal} kWh</b>.</p><p>${ok1?"‚úÖ":"‚ùå"} Les parts recomposent bien Q_apr√®s ‚Ä¢ ${ok2?"‚úÖ":"‚ùå"} Q_avant + Q_apr√®s = Œîindex.</p>`);L.push(`<h4>R√©sum√©</h4><p>Sur cette p√©riode, l‚ÄôAP a lieu le <b>${fmtDate(da)}</b> (index <b>${A}</b>). Avant l‚ÄôAP, tout revient au p√®re ; apr√®s l‚ÄôAP, la r√©partition devient <b>${pctText(k)} %</b> p√®re / <b>${pctText(1-k)} %</b> fils. <b>Part facturable au p√®re</b> : <b>${fatherTotal} kWh</b>.</p>`);} else if(ds&&da&&de&&!validOrder){L.push(`<p class="muted">‚ö† Ordre requis : <b>N-1 ‚â§ AP ‚â§ Anniversaire</b> et index croissants.</p>`);}
  chroniqueLive.innerHTML=L.join("");
}

function compute1(){
  chroniqueLive=document.getElementById('chroniqueLive1');
  const FS=fStart1.value, FE=fEnd1.value;
  const ds=dStart11.value, da=dAP1.value, de=dEnd1.value;
  const S=asNum(iStart1.value), A=asNum(iAP1.value), E=asNum(iEnd1.value);
  const k=asNum(coef1.value);
  const validOrder=(ds&&da&&de)?(new Date(ds)<=new Date(da)&&new Date(da)<=new Date(de)&&S<=A&&A<=E):false;

  let q1=NaN,q2=NaN,fatherAfter=NaN,childAfter=NaN,fatherTotal=NaN,ok1=false,ok2=false;
  const ready=ds&&da&&de&&[S,A,E].every(Number.isFinite)&&(k>=0&&k<=1)&&validOrder;

  if(ready){q1=A-S;q2=E-A;fatherAfter=Math.round(q2*k);childAfter=q2-fatherAfter;fatherTotal=q1+fatherAfter;ok1=(fatherAfter+childAfter===q2);ok2=((E-S)===(q1+q2));}

  if(view1==="time"){
    drawTimeline(timeline1,[{tag:"fstart",d:FS?new Date(FS):null},{tag:"fend",d:FE?new Date(FE):null},{d:ds?new Date(ds):null,idx:S},{d:da?new Date(da):null,idx:A},{d:de?new Date(de):null,idx:E},{d:(ds&&da)?new Date((+new Date(ds)+(+new Date(da)))/2):null,lbl:"100 % p√®re"},{d:(da&&de)?new Date((+new Date(da)+(+new Date(de)))/2):null,lbl:(k>=0&&k<=1?`${pctText(k)} % p√®re`:"")}]);
  } else {
    const p2=Number.isFinite(q2)&&Number.isFinite(k)?Math.round(q2*k):NaN;
    const c2=Number.isFinite(q2)&&Number.isFinite(p2)?q2-p2:NaN;
    drawStackedPF1(bars1,{q1,q2,p2,c2,ds,da,de});
  }

  const coefPct=pctText(k);
  if(ready){
    let line=`BAP : augmentation de puissance au ${fmtDate(da)} (index ${raw(A)}) ; avant AP : ${raw(A)} - ${raw(S)} = ${raw(q1)} ; apr√®s AP : ${raw(E)} - ${raw(A)} = ${raw(q2)} √ó ${coefPct} % = ${raw(fatherAfter)} ‚áí quantit√© attendue (p√®re) = ${raw(q1)} + ${raw(fatherAfter)}`;
    const pStr=(price1.value||"").trim(),pNum=asNum(pStr);
    if(pStr&&Number.isFinite(pNum)){const amount=(fatherTotal*pNum).toLocaleString("fr-FR",{minimumFractionDigits:2,maximumFractionDigits:2});line+=` soit ${raw(fatherTotal)} √ó ${pStr} = ${amount}‚Ç¨`;}
    bap1.value=line;
  } else {bap1.value="";}

  renderChroniqueLive({FS,FE,ds,S,da,A,de,E,k,q1,q2,fatherAfter,childAfter,fatherTotal,validOrder,ok1,ok2,ready});
}

/* Exemple PF1 (verrouill√©) */
function compute1Example(){const FS="2024-03-05",FE="2025-03-05";const ds="2024-03-05",S=12000;const da="2024-08-20",A=18450;const de="2025-03-05",E=25380;const k=0.70;
  document.getElementById('fStart1X').value=FS;document.getElementById('fEnd1X').value=FE;document.getElementById('dStart1X').value=ds;document.getElementById('iStart1X').value=S;document.getElementById('dAP1X').value=da;document.getElementById('iAP1X').value=A;document.getElementById('dEnd1XX').value=de;document.getElementById('iEnd1X').value=E;document.getElementById('coef1X').value=k;
  const q1=A-S,q2=E-A,fA=Math.round(q2*k),cA=q2-fA,fTot=q1+fA;
  drawTimeline(document.getElementById('timeline1X'),[{tag:"fstart",d:new Date(FS)},{tag:"fend",d:new Date(FE)},{d:new Date(ds),idx:S},{d:new Date(da),idx:A},{d:new Date(de),idx:E},{d:new Date((+new Date(ds)+(+new Date(da)))/2),lbl:"100 % p√®re"},{d:new Date((+new Date(da)+(+new Date(de)))/2),lbl:`${pctText(k)} % p√®re`}]);
  drawStackedPF1(document.getElementById('bars1X'),{q1,q2,p2:fA,c2:cA,ds,da,de});
  document.getElementById('chroniqueLive1X').innerHTML=`<h4>Le cadre</h4><p>Exemple sur une <span class="chip">${guessPeriodLabel(FS,FE)}</span> du <b>${fmtDate(FS)}</b> au <b>${fmtDate(FE)}</b>.</p><p>Rep√®res : N-1 ${fmtDate(ds)} (<b>${S}</b>) ‚Ä¢ AP ${fmtDate(da)} (<b>${A}</b>) ‚Ä¢ Anniv. ${fmtDate(de)} (<b>${E}</b>).</p><h4>Calcul</h4><p>Avant AP : <b>${A} ‚àí ${S} = ${q1} kWh</b> (100 % p√®re).</p><p>Apr√®s AP : <b>${E} ‚àí ${A} = ${q2} kWh</b> ‚Üí p√®re <b>${fA}</b> ‚Ä¢ fils <b>${cA}</b>. <b>Total p√®re</b> = <b>${fTot} kWh</b>.</p>`;
}

/* ===== PF2 ===== */
const fStart2=document.getElementById('fStart2'), fEnd2=document.getElementById('fEnd2');
const dStart2=document.getElementById('dStart2'), iStart2=document.getElementById('iStart2');
const dAP21=document.getElementById('dAP21'), iAP21=document.getElementById('iAP21');
const dAP22=document.getElementById('dAP22'), iAP22=document.getElementById('iAP22');
const dEnd2=document.getElementById('dEnd2'), iEnd2=document.getElementById('iEnd2');
const coef21_pere=document.getElementById('coef21_pere'), coef22_pere=document.getElementById('coef22_pere');
const coef22_fils=document.getElementById('coef22_fils'), coef22_petit=document.getElementById('coef22_petit');
const price2=document.getElementById('price2');
const v2timeBtn=document.getElementById('v2time'), v2barsBtn=document.getElementById('v2bars');
const timeline2=document.getElementById('timeline2'), bars2=document.getElementById('timeline2bars'), bap2=document.getElementById('bap2');
const chrono2=document.getElementById('chroniqueLive2'); let view2="time";

function renderChroniqueLive2(v){const{FS,FE,ds,S,da1,A1,da2,A2,de,E,k1,k2p,k2f,k2c,q1,q2,q3,p1,c1,p2,c2,g2,totP,validOrder,coefsOK2,okSeg2,okSeg3,okDelta,ready}=v;const L=[];
  if(FS&&FE){L.push(`<h4>Le cadre</h4><p>P√©riode trait√©e : <b>${fmtDate(FS)}</b> ‚Üí <b>${fmtDate(FE)}</b> (<span class="chip">${guessPeriodLabel(FS,FE)}</span>) avec deux AP : entr√©e du fils (AP1) puis du petit-fils (AP2).</p>`);} else {L.push(`<h4>Le cadre</h4><p class="muted">Renseigne la p√©riode de la facture.</p>`);}
  const R=[];if(ds)R.push(`N-1 ${fmtDate(ds)} : <b>${Number.isFinite(S)?S:"?"}</b>`);if(da1)R.push(`AP1 ${fmtDate(da1)} : <b>${Number.isFinite(A1)?A1:"?"}</b>`);if(da2)R.push(`AP2 ${fmtDate(da2)} : <b>${Number.isFinite(A2)?A2:"?"}</b>`);if(de)R.push(`Anniv. ${fmtDate(de)} : <b>${Number.isFinite(E)?E:"?"}</b>`);L.push(R.length?`<p>Rep√®res index : ${R.join(" ‚Ä¢ ")}.</p>`:`<p class="muted">Rep√®res attendus : N-1 ‚Üí AP1 ‚Üí AP2 ‚Üí Anniversaire.</p>`);
  if(da1&&da2)L.push(`<p><b>Entre AP1 et AP2</b> : p√®re <b>${pctText(k1)} %</b> ‚Ä¢ fils <b>${pctText(1-k1)} %</b>.</p>`);
  if(de){if(coefsOK2){L.push(`<p><b>Apr√®s AP2</b> : p√®re <b>${pctText(k2p)} %</b> ‚Ä¢ fils <b>${pctText(k2f)} %</b> ‚Ä¢ petit-fils <b>${pctText(k2c)} %</b> (100 % au total).</p>`);}else{L.push(`<p class="muted">Apr√®s AP2, renseigne 3 parts (p√®re/fils/petit-fils) qui totalisent 100 %.</p>`);}}
  if(ready){L.push(`<h4>Calcul clair</h4><p>Avant AP1 : <b>${A1} ‚àí ${S} = ${q1} kWh</b> (100 % p√®re).</p><p>AP1 ‚Üí AP2 : <b>${A2} ‚àí ${A1} = ${q2} kWh</b> ‚Üí p√®re <b>${p1}</b> ‚Ä¢ fils <b>${c1}</b>.</p><p>Apr√®s AP2 : <b>${E} ‚àí ${A2} = ${q3} kWh</b> ‚Üí p√®re <b>${p2}</b> ‚Ä¢ fils <b>${c2}</b> ‚Ä¢ petit-fils <b>${g2}</b>.</p><p><b>Part p√®re attendue :</b> <b>${totP} kWh</b>.</p><p>${okSeg2?"‚úÖ":"‚ùå"} S2 : parts = Q‚ÇÇ ‚Ä¢ ${okSeg3?"‚úÖ":"‚ùå"} S3 : parts = Q‚ÇÉ ‚Ä¢ ${okDelta?"‚úÖ":"‚ùå"} S1+S2+S3 = Œîindex.</p>`);const repS2=`${pctText(k1)} % au p√®re et ${pctText(1-k1)} % au fils`;const repS3=`${pctText(k2p)} % au p√®re, ${pctText(k2f)} % au fils, ${pctText(k2c)} % au petit-fils`;L.push(`<h4>R√©sum√©</h4><p>AP1 le <b>${fmtDate(da1)}</b> (index ${A1}) fait entrer le fils : ventilation ${repS2} jusqu‚Äô√† AP2 le <b>${fmtDate(da2)}</b> (index ${A2}). D‚ÄôAP2 √† l‚Äôanniversaire (${fmtDate(de)}), r√©partition ${repS3}. <b>Part facturable p√®re</b> : <b>${totP} kWh</b> (= ${q1} + ${p1} + ${p2}).</p>`);} else if(ds&&da1&&da2&&de&&!validOrder){L.push(`<p class="muted">‚ö† Ordre chronologique : <b>N-1 ‚â§ AP1 ‚â§ AP2 ‚â§ Anniversaire</b> et index croissants.</p>`);}
  chrono2.innerHTML=L.join("");
}

function compute2(){
  const FS=fStart2.value,FE=fEnd2.value,ds=dStart2.value,da1=dAP21.value,da2=dAP22.value,de=dEnd2.value;
  const S=asNum(iStart2.value),A1=asNum(iAP21.value),A2=asNum(iAP22.value),E=asNum(iEnd2.value);
  const k1=asNum(coef21_pere.value),k2p=asNum(coef22_pere.value),k2f=asNum(coef22_fils.value),k2c=asNum(coef22_petit.value);
  const validOrder=(ds&&da1&&da2&&de)?(new Date(ds)<=new Date(da1)&&new Date(da1)<=new Date(da2)&&new Date(da2)<=new Date(de)&&S<=A1&&A1<=A2&&A2<=E):false;
  const coefsOK2=[k2p,k2f,k2c].every(x=>x>=0&&x<=1)&&Math.abs((k2p+k2f+k2c)-1)<1e-6;

  let q1=NaN,q2=NaN,q3=NaN,p1=NaN,c1=NaN,p2=NaN,c2=NaN,g2=NaN,totP=NaN,okSeg2=false,okSeg3=false,okDelta=false;
  const ready=ds&&da1&&da2&&de&&[S,A1,A2,E].every(Number.isFinite)&&Number.isFinite(k1)&&coefsOK2&&validOrder;

  if(ready){q1=A1-S;q2=A2-A1;q3=E-A2;p1=Math.round(q2*k1);c1=q2-p1;p2=Math.round(q3*k2p);c2=Math.round(q3*k2f);g2=q3-p2-c2;totP=q1+p1+p2;okSeg2=(p1+c1===q2);okSeg3=(p2+c2+g2===q3);okDelta=((E-S)===(q1+q2+q3));}

  if(view2==="time"){
    drawTimeline(timeline2,[{tag:"fstart",d:FS?new Date(FS):null},{tag:"fend",d:FE?new Date(FE):null},{d:ds?new Date(ds):null,idx:S},{d:da1?new Date(da1):null,idx:A1},{d:da2?new Date(da2):null,idx:A2},{d:de?new Date(de):null,idx:E},{d:(ds&&da1)?new Date((+new Date(ds)+(+new Date(da1)))/2):null,lbl:"S1 : 100 % p√®re"},{d:(da1&&da2)?new Date((+new Date(da1)+(+new Date(da2)))/2):null,lbl:(Number.isFinite(k1)?`S2 : ${pctText(k1)} % p√®re`:"S2")},{d:(da2&&de)?new Date((+new Date(da2)+(+new Date(de)))/2):null,lbl:(coefsOK2?`S3 : ${pctText(k2p)} % p√®re`:"S3")}]);
  } else {
    drawStackedPF2(bars2,{q1,q2,q3,p1,c1,p2,c2,g2,ds,da1,da2,de});
  }

  if(ready){
    let line=[`BAP : AP1 au ${fmtDate(da1)} (index ${A1}) puis AP2 au ${fmtDate(da2)} (index ${A2})`,
              `; avant AP1 : ${A1} - ${S} = ${q1}`,
              `; entre AP1 et AP2 : ${A2} - ${A1} = ${q2} √ó ${pctText(k1)} % = ${p1}`,
              `; apr√®s AP2 : ${E} - ${A2} = ${q3} √ó ${pctText(k2p)} % = ${p2}`,
              `‚áí quantit√© attendue (p√®re) = ${q1} + ${p1} + ${p2}`].join(" ");
    const pStr=(price2.value||"").trim(),pNum=asNum(pStr);
    bap2.value=(pStr&&Number.isFinite(pNum))?`${line} soit ${totP} √ó ${pStr} = ${(totP*pNum).toLocaleString("fr-FR",{minimumFractionDigits:2,maximumFractionDigits:2})}‚Ç¨`:line;
  } else {bap2.value="";}

  renderChroniqueLive2({FS,FE,ds,S,da1,A1,da2,A2,de,E,k1,k2p,k2f,k2c,q1,q2,q3,p1,c1,p2,c2,g2,totP,validOrder,coefsOK2,okSeg2,okSeg3,okDelta,ready});
}

/* Exemple PF2 (verrouill√©) */
function compute2Example(){const FS="2024-01-01",FE="2024-12-31",ds="2024-01-01",S=5000,da1="2024-04-01",A1=6200,da2="2024-09-15",A2=9100,de="2024-12-31",E=11200,k1=0.70,k2p=0.60,k2f=0.25,k2c=0.15;
  fStart2X.value=FS;fEnd2X.value=FE;dStart2X.value=ds;iStart2X.value=S;dAP21X.value=da1;iAP21X.value=A1;dAP22X.value=da2;iAP22X.value=A2;dEnd2XX.value=de;iEnd2X.value=E;coef21_pereX.value=k1;coef22_pereX.value=k2p;coef22_filsX.value=k2f;coef22_petitX.value=k2c;
  const q1=A1-S,q2=A2-A1,q3=E-A2,p1=Math.round(q2*k1),c1=q2-p1,p2=Math.round(q3*k2p),c2=Math.round(q3*k2f),g2=q3-p2-c2;
  chroniqueLive2X.innerHTML=`<h4>Le cadre</h4><p>Exemple d‚Äôune <span class="chip">${guessPeriodLabel(FS,FE)}</span> du <b>${fmtDate(FS)}</b> au <b>${fmtDate(FE)}</b> avec deux AP.</p><p>Rep√®res : N-1 ${fmtDate(ds)} (<b>${S}</b>) ‚Ä¢ AP1 ${fmtDate(da1)} (<b>${A1}</b>) ‚Ä¢ AP2 ${fmtDate(da2)} (<b>${A2}</b>) ‚Ä¢ Anniv. ${fmtDate(de)} (<b>${E}</b>).</p><h4>Calcul</h4><p>S1 : <b>${A1} ‚àí ${S} = ${q1} kWh</b>.</p><p>S2 : <b>${A2} ‚àí ${A1} = ${q2} kWh</b> ‚Üí p√®re <b>${p1}</b> ‚Ä¢ fils <b>${c1}</b>.</p><p>S3 : <b>${E} ‚àí ${A2} = ${q3} kWh</b> ‚Üí p√®re <b>${p2}</b> ‚Ä¢ fils <b>${c2}</b> ‚Ä¢ petit-fils <b>${g2}</b>.</p>`;
  drawTimeline(timeline2X,[{tag:"fstart",d:new Date(FS)},{tag:"fend",d:new Date(FE)},{d:new Date(ds),idx:S},{d:new Date(da1),idx:A1},{d:new Date(da2),idx:A2},{d:new Date(de),idx:E},{d:new Date((+new Date(ds)+(+new Date(da1)))/2),lbl:"S1 : 100 % p√®re"},{d:new Date((+new Date(da1)+(+new Date(da2)))/2),lbl:`S2 : ${pctText(k1)} % p√®re`},{d:new Date((+new Date(da2)+(+new Date(de)))/2),lbl:`S3 : ${pctText(k2p)} % p√®re`}]);
  drawStackedPF2(bars2X,{q1,q2,q3,p1,c1,p2,c2,g2,ds,da1,da2,de});
}

/* Init */
window.addEventListener('DOMContentLoaded',()=>{
  // PF1
  [fStart1,fEnd1,dStart11,iStart1,dAP1,iAP1,dEnd1,iEnd1,coef1,price1].forEach(e=>e.addEventListener('input',compute1));
  exA1.addEventListener('click',()=>{fStart1.value="2024-03-05";fEnd1.value="2025-03-05";dStart11.value="2024-03-05";iStart1.value="12000";dAP1.value="2024-08-20";iAP1.value="18450";dEnd1.value="2025-03-05";iEnd1.value="25380";coef1.value="0.70";price1.value="0.10";compute1();});
  exB1.addEventListener('click',()=>{fStart1.value="2019-10-24";fEnd1.value="2020-10-23";dStart11.value="2019-10-24";iStart1.value="0";dAP1.value="2020-05-27";iAP1.value="1715";dEnd1.value="2020-10-23";iEnd1.value="3112";coef1.value="0.80";price1.value="";compute1();});
  clear1.addEventListener('click',()=>{[fStart1,fEnd1,dStart11,iStart1,dAP1,iAP1,dEnd1,iEnd1,coef1,price1].forEach(e=>e.value="");chroniqueLive1.innerHTML="";timeline1.innerHTML="";bars1.innerHTML="";bap1.value="";});
  copy1.addEventListener('click',()=>{bap1.select();document.execCommand('copy');});
  v1time.addEventListener('click',()=>{view1="time";v1time.classList.add('active');v1bars.classList.remove('active');document.getElementById('view1-time').classList.add('active');document.getElementById('view1-bars').classList.remove('active');compute1();});
  v1bars.addEventListener('click',()=>{view1="bars";v1bars.classList.add('active');v1time.classList.remove('active');document.getElementById('view1-bars').classList.add('active');document.getElementById('view1-time').classList.remove('active');compute1();});
  compute1Example();

  // PF2
  [fStart2,fEnd2,dStart2,iStart2,dAP21,iAP21,dAP22,iAP22,dEnd2,iEnd2,coef21_pere,coef22_pere,coef22_fils,coef22_petit,price2].forEach(e=>e.addEventListener('input',compute2));
  ex2.addEventListener('click',()=>{fStart2.value="2024-01-01";fEnd2.value="2024-12-31";dStart2.value="2024-01-01";iStart2.value="5000";dAP21.value="2024-04-01";iAP21.value="6200";dAP22.value="2024-09-15";iAP22.value="9100";dEnd2.value="2024-12-31";iEnd2.value="11200";coef21_pere.value="0.70";coef22_pere.value="0.60";coef22_fils.value="0.25";coef22_petit.value="0.15";price2.value="0.10";compute2();});
  clear2.addEventListener('click',()=>{[fStart2,fEnd2,dStart2,iStart2,dAP21,iAP21,dAP22,iAP22,dEnd2,iEnd2,coef21_pere,coef22_pere,coef22_fils,coef22_petit,price2].forEach(e=>e.value="");chroniqueLive2.innerHTML="";timeline2.innerHTML="";timeline2bars.innerHTML="";bap2.value="";});
  copy2.addEventListener('click',()=>{bap2.select();document.execCommand('copy');});
  v2time.addEventListener('click',()=>{view2="time";v2time.classList.add('active');v2bars.classList.remove('active');document.getElementById('view2-time').classList.add('active');document.getElementById('view2-bars').classList.remove('active');compute2();});
  v2bars.addEventListener('click',()=>{view2="bars";v2bars.classList.add('active');v2time.classList.remove('active');document.getElementById('view2-bars').classList.add('active');document.getElementById('view2-time').classList.remove('active');compute2();});
  compute2Example();
});
</script>
</body>
</html>
